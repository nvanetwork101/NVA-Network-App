<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NVA Network</title>
    <!-- Google Fonts - Bebas Neue for title, Inter for body -->
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PWA Enhancements START -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    <meta name="theme-color" content="#0A0A0A">
    <!-- PWA Enhancements END -->
    <style>
        html, body {
            height: 100%; /* Ensure html and body take full height */
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font as per instructions */
            background-color: #0A0A0A;
            color: #FFF;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top to allow scrolling from the top */
            min-height: 100vh; /* Ensure body is at least viewport height */
            overflow-y: auto; /* Allow vertical scrolling for the entire body */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        #root {
            width: 100%;
            max-width: 450px; /* Typical mobile width constraint */
            /* Removed height: 100vh; to allow it to expand with content */
            background-color: #0A0A0A;
            display: flex;
            flex-direction: column;
            border-radius: 15px; /* Rounded corners for the main app container */
            /* Removed overflow: hidden; to allow content to push height */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            min-height: 100vh; /* Ensure #root is at least viewport height */
        }
        .container {
            flex: 1;
            background-color: #0A0A0A; /* Dark background */
            display: flex;
            flex-direction: column;
        }
        .header {
            position: relative; /* For absolute positioning of children and pseudo-element */
            height: 150px; /* Header height */
            padding: 0; /* No padding */
            background-color: #1A1A1A;
            border-bottom: 1px solid #333;
            border-radius: 15px 15px 0 0; /* Rounded top corners */
            overflow: hidden; /* Ensure content stays within bounds */
            z-index: 0; /* Establish a stacking context for its children */
        }
        /* Abstract grey art background for header, behind text */
        /* Removed .header::before rule */
        .headerTitle {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #FFD700; /* Gold color for branding */
            z-index: 3; /* Ensure it's above the abstract art */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7); /* Add subtle shadow for readability */
            font-family: 'Bebas Neue', sans-serif; /* Applied new font */
            font-size: 38px; /* Slightly larger for impact */
        }
        .tagline {
            position: absolute;
            bottom: 15px; /* Position at the bottom left */
            left: 15px; /* Position at the bottom left */
            font-size: 14px;
            color: #AAA; /* Original color */
            font-weight: normal; /* Original font weight */
            text-align: left; /* Align text to the left */
            z-index: 3; /* Ensure it's above the abstract art */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7); /* Add subtle shadow for readability */
        }
        .navigationBar {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background-color: #1A1A1A;
            border-top: 1px solid #333;
            border-radius: 0 0 15px 15px; /* Rounded bottom corners */
            /* Removed flex-wrap and gap as Support Us is moved */
        }
        .navButton {
            padding: 8px 15px;
            border-radius: 25px; /* Adjusted for consistency with other buttons */
            cursor: pointer;
            transition: background-color 0.3s ease;
            background-color: #FFD700; /* Changed to gold for visibility */
            box-shadow: 0 4px 5px rgba(0, 0, 0, 0.3);
            border: none; /* Removed border */
        }
        .navButton:hover {
            background-color: #FFC400;
        }
        .navButtonText {
            color: #0A0A0A; /* Changed to black for visibility */
            font-size: 14px;
            font-weight: 600;
        }
        .activeNavButtonText {
            color: #0A0A0A; /* Changed to black for visibility on gold background */
        }
        .screenContainer {
            flex: 1;
            padding: 15px;
            /* Removed overflow-y: auto; here as body will handle overall scrolling */
            position: relative; /* Added for positioning the new support button */
        }
        .sectionTitle {
            font-size: 20px;
            font-weight: bold;
            color: #FFF;
            margin-bottom: 15px;
            margin-top: 20px;
        }
        .contentGrid {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .contentCard {
            width: calc(50% - 7.5px); /* Roughly half width for two columns with spacing */
            margin-bottom: 15px;
            background-color: #2A2A2A;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.8);
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .contentCard:hover {
            transform: translateY(-3px);
        }
        .thumbnailPlaceholder {
            width: 100%;
            height: 100px;
            background-color: #444;
            display: flex;
            flex-direction: column; /* To stack text and icon */
            justify-content: center;
            align-items: center;
            position: relative; /* For play icon positioning */
        }
        .thumbnailText {
            color: #FFF;
            font-size: 12px;
            margin-bottom: 5px; /* Space between text and icon */
        }
        .playIcon {
            width: 30px;
            height: 30px;
            fill: #FFD700; /* Gold color for play icon */
            opacity: 0.8;
        }
        .contentTitle {
            font-size: 14px;
            font-weight: bold;
            color: #FFF;
            padding: 10px;
        }
        .categoryTabs {
            margin-bottom: 15px;
            height: 40px;
            display: flex;
            overflow-x: auto; /* Enable horizontal scrolling for tabs */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            padding-bottom: 5px; /* Space for scrollbar */
        }
        .categoryTab {
            padding: 8px 15px;
            border-radius: 20px;
            background-color: #3A3A3A;
            margin-right: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0; /* Prevent tabs from shrinking */
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .categoryTab:hover {
            background-color: #4A4A4A;
        }
        .activeCategoryTab {
            background-color: #FFD700; /* Gold highlight for active category */
        }
        .categoryTabText {
            color: #FFF;
            font-weight: 600;
            white-space: nowrap; /* Prevent text wrapping */
        }
        .activeCategoryTabText {
            color: #0A0A0A; /* Dark text on gold background */
        }
        .categoryContent {
            flex: 1;
            /* Removed overflow-y: auto; here as body will handle overall scrolling */
        }
        /* Horizontal Carousel Styles (Featured Highlights) */
        .horizontal-carousel-container {
            width: 100%;
            overflow-x: hidden; /* Hide scrollbar, manage scrolling with JS */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            scroll-snap-type: x mandatory; /* Snap to items */
            scroll-behavior: smooth; /* Smooth scrolling animation */
            display: flex; /* Arrange items in a row */
            padding-bottom: 10px; /* Space for scrollbar */
            margin-bottom: 20px; /* Space below carousel */
        }

        .horizontal-carousel-item {
            flex: 0 0 calc(33.33% - 10px); /* Show 3 items, account for margin */
            margin-right: 15px; /* Spacing between items */
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.8);
            scroll-snap-align: start; /* Snap to the start of each item */
            background-color: #2A2A2A; /* Placeholder background */
            display: flex;
            justify-content: center;
            align-items: center;
            color: #FFF;
            font-size: 12px;
            height: 100px; /* Fixed height for carousel images */
        }
        .horizontal-carousel-item:last-child {
            margin-right: 0; /* No margin on the last item */
        }
        .carousel-image {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Cover the item area */
            border-radius: 10px; /* Inherit border-radius */
        }

        /* Vertical Carousel Styles (Live Feed) */
        .vertical-carousel-container {
            width: 100%;
            height: 250px; /* Fixed height for vertical carousel to show ~2 items */
            overflow-y: hidden; /* Hide scrollbar, manage scrolling with JS */
            -webkit-overflow-scrolling: touch; /* Enable touch scrolling */
            scroll-snap-type: y mandatory; /* Snap to items */
            scroll-behavior: smooth; /* Smooth scrolling animation */
            display: flex;
            flex-direction: column; /* Arrange items in a column */
            margin-bottom: 20px;
            background-color: #1A1A1A;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.8);
        }

        .vertical-carousel-item {
            flex: 0 0 calc(50% - 10px); /* Show 2 items per view, with a gap */
            margin-bottom: 15px; /* Space between items */
            background-color: #2A2A2A;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            scroll-snap-align: start; /* Snap to the start of each item */
            display: flex;
            align-items: center;
            padding: 10px;
        }

        .vertical-carousel-item:last-child {
            margin-bottom: 0;
        }

        .liveFeedThumbnail {
            width: 80px; /* Fixed width for live feed thumbnails */
            height: 60px; /* Fixed height for live feed thumbnails (16:9 aspect ratio) */
            object-fit: cover;
            border-radius: 8px;
            margin-right: 10px;
        }

        .liveFeedContent {
            flex-grow: 1;
        }

        .liveFeedTitle {
            font-size: 14px;
            font-weight: bold;
            color: #FFF;
            margin-bottom: 5px;
        }

        .liveFeedCreator {
            font-size: 12px;
            color: #AAA;
        }

        .heading {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
            text-align: center;
        }
        .subHeading {
            font-size: 16px;
            color: #FFF;
            margin-bottom: 20px;
            text-align: center;
        }
        .paragraph {
            font-size: 14px;
            color: #CCC;
            margin-bottom: 10px;
            line-height: 20px;
        }
        .button {
            background-color: #FFD700;
            padding: 12px 25px;
            border-radius: 25px;
            align-self: center;
            margin-top: 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 5px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .button:hover {
            background-color: #FFC400;
        }
        .buttonText {
            color: #0A0A0A;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
        }
        .smallText {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-bottom: 10px;
        }
        .listItem {
            font-size: 14px;
            color: #CCC;
            margin-left: 15px;
            margin-bottom: 5px;
        }
        .premiumFeatureCard {
            background-color: #2A2A2A;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
        }
        .premiumFeatureTitle {
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }
        .premiumFeatureDescription {
            font-size: 14px;
            color: #CCC;
            line-height: 20px;
        }
        .pricingTable {
            background-color: #2A2A2A;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        .pricingRow {
            display: flex;
            justify-content: space-between;
            padding-top: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        .pricingRow:last-child {
            border-bottom: none; /* No border for the last row */
        }
        .pricingTier {
            font-size: 16px;
            font-weight: bold;
            color: #FFD700;
            flex: 1;
        }
        .pricingFeatures {
            font-size: 14px;
            color: #CCC;
            flex: 2;
            text-align: left;
            margin-left: 10px;
        }
        .pricingPrice {
            font-size: 16px;
            font-weight: bold;
            color: #FFF;
            flex: 1;
            text-align: right;
        }
        .contactInfo {
            font-size: 14px;
            color: #CCC;
            margin-bottom: 5px;
        }
        .messageBox {
            position: fixed; /* Use fixed for overlay */
            bottom: 100px; /* Above navigation bar */
            left: 50%;
            transform: translateX(-50%); /* Center horizontally */
            background-color: rgba(0, 0, 0, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Allow clicks to pass through */
            max-width: 90%;
        }
        .messageBox.hidden {
            opacity: 0;
        }
        .messageText {
            color: #FFF;
            text-align: center;
            font-size: 14px;
        }
        /* Video Modal Styles */
        .videoModalOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .videoModalContent {
            background-color: #1A1A1A;
            border-radius: 0; /* Removed for full screen effect */
            width: 100vw; /* Make it take 100% of viewport width */
            height: 100vh; /* Make it take 100% of viewport height */
            max-width: 1200px; /* Cap maximum width for very large screens */
            max-height: 800px; /* Cap maximum height for very large screens to maintain aspect ratio */
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
            position: relative;
            display: flex; /* Enable flex for vertical centering of iframe */
            flex-direction: column;
            justify-content: center; /* Center content vertically */
            align-items: center; /* Center content horizontally */
        }
        .videoIframeContainer {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio (height relative to width) */
            height: 0; /* Important for padding-bottom trick */
            overflow: hidden;
        }
        .videoIframeContainer iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        .videoModalContent.vertical {
            max-width: 450px; /* Optimal width for phone-like vertical view */
            height: 100vh;
            max-height: 100vh; /* Ensure it takes full viewport height */
            justify-content: center; /* Center the iframe vertically */
        }

        .videoIframeContainer.vertical {
            padding-bottom: 177.77%; /* 9:16 aspect ratio (16 / 9 * 100) */
        }
        .closeButton {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            color: #FFF;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10; /* Ensure it's above the iframe */
        }

        /* Styles for buttons at the top of the Home screen */
        .topRightButtonContainer {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px; /* Space between buttons */
            z-index: 10;
        }

        .topButton {
            background-color: #FFD700; /* Gold color */
            color: #0A0A0A; /* Dark text */
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px; /* Smaller font for a compact button */
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            border: none;
            transition: background-color 0.3s ease;
        }
        .topButton:hover {
            background-color: #FFC400;
        }


        /* Styles for Creator Campaign Cards */
        .campaignCard {
            background-color: #2A2A2A;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }
        .campaignTitle {
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }
        .campaignCreator {
            font-size: 14px;
            color: #CCC;
            margin-bottom: 10px;
        }
        .campaignDescription {
            font-size: 14px;
            color: #AAA;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .campaignProgressContainer {
            width: 100%;
            background-color: #444;
            border-radius: 5px;
            height: 10px;
            margin-bottom: 5px;
            overflow: hidden; /* Ensure progress bar stays within bounds */
        }
        .campaignProgressBar {
            height: 100%;
            background-color: #FFD700;
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }
        .campaignStats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #CCC;
            width: 100%;
        }
        .campaignGoal, .campaignRaised {
            font-weight: bold;
            color: #FFF;
        }
        .campaignButton {
            background-color: #FFD700;
            padding: 10px 15px;
            border-radius: 20px;
            color: #0A0A0A;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .campaignButton:hover {
            background-color: #FFC400;
        }

        /* Styles for Creator Sign Up Form */
        .formGroup {
            margin-bottom: 15px;
        }
        .formLabel {
            display: block;
            font-size: 14px;
            color: #FFF;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .formInput, .formTextarea {
            width: calc(100% - 20px); /* Account for padding */
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #333;
            color: #FFF;
            font-size: 14px;
        }
        .formTextarea {
            resize: vertical; /* Allow vertical resizing */
            min-height: 80px;
        }
        .checkboxGroup {
            margin-bottom: 15px;
        }
        .checkboxLabel {
            display: block;
            font-size: 14px;
            color: #FFF;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .checkboxItem {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .checkboxItem input[type="checkbox"] {
            margin-right: 8px;
            width: 18px; /* Larger checkbox for touch */
            height: 18px;
            accent-color: #FFD700; /* Highlight checkbox */
        }
        .termsText {
            font-size: 12px;
            color: #AAA;
            margin-top: 10px;
            line-height: 1.4;
        }
        .termsLink {
            color: #FFD700;
            text-decoration: none;
            font-weight: bold;
        }
        .termsLink:hover {
            text-decoration: underline;
        }

        /* Styles for Creator Dashboard */
        .dashboardSection {
            background-color: #2A2A2A;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
        }
        .dashboardSectionTitle {
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
        }
        .dashboardItem {
            font-size: 14px;
            color: #CCC;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .dashboardButton {
            background-color: #FFD700;
            padding: 8px 15px;
            border-radius: 20px;
            color: #0A0A0A;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
            margin-top: 10px;
            margin-right: 10px;
        }
        .dashboardButton:hover {
            background-color: #FFC400;
        }
        .dashboardContentList {
            margin-top: 10px;
            padding-left: 0; /* Remove default ul padding */
            list-style: none; /* Remove bullet points */
        }
        .dashboardContentListItem {
            background-color: #3A3A3A;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #FFF;
        }
        .dashboardContentListItem span {
            flex-grow: 1;
        }
        .dashboardContentListItem .actionButton {
            background-color: #555;
            color: #FFF;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: background-color 0.2s ease;
        }
        .dashboardContentListItem .actionButton:hover {
            background-color: #777;
        }

        /* New styles for video link sections in dashboard */
        .videoLinkSection {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        .videoLinkSection:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .videoLinkSection .formLabel {
            margin-bottom: 10px;
            font-size: 16px;
            color: #FFD700;
        }
        .videoInputContainer {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .videoInputContainer .formInput {
            flex-grow: 1;
        }
        .videoThumbnailContainer {
            position: relative;
            width: 100%;
            height: 150px; /* Fixed height for thumbnails */
            background-color: #444;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer; /* Indicate clickable */
        }
        .videoThumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .videoThumbnailOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .thumbnailPlayIcon {
            width: 40px;
            height: 40px;
            fill: #FFF;
            opacity: 0.9;
        }
        .videoActions {
            display: flex;
            justify-content: flex-end; /* Align buttons to the right */
            gap: 10px;
        }
        .videoActions .actionButton {
            background-color: #FFD700;
            color: #0A0A0A;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .videoActions .actionButton.remove {
            background-color: #DC3545; /* Red for remove */
            color: #FFF;
        }
        .videoActions .actionButton:hover {
            background-color: #FFC400;
        }
        .videoActions .actionButton.remove:hover {
            background-color: #C82333;
        }
        /* New styles for login form */
        .loginForm {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .loginForm .button {
            width: 100%;
        }
        /* New styling for section title with aligned button */
        .sectionHeaderWithButton {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px; /* Space below the header container */
            margin-top: 20px;
        }
        .sectionHeaderWithButton .sectionTitle {
            margin: 0; /* Remove default margins from p tag when in flex container */
        }
        /* Adjust .topButton styles for this context if needed, or create a new class */
        .sectionHeaderButton {
            background-color: #FFD700; /* Gold color */
            color: #0A0A0A; /* Dark text */
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px; /* Smaller font for a compact button */
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            border: none;
            transition: background-color 0.3s ease;
        }
        .sectionHeaderButton:hover {
            background-color: #FFC400;
        }

        /* Profile Picture Adjustment Modal Styles */
        .imageAdjustModalOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95); /* More opaque */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Higher z-index than video modal */
            flex-direction: column;
            gap: 20px;
        }

        .imageAdjustModalContent {
            background-color: #1A1A1A;
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .canvasContainer {
            position: relative;
            width: 200px; /* Fixed size for the canvas view */
            height: 200px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #FFD700;
            background-color: #333;
            margin-bottom: 20px;
            cursor: grab;
        }

        .canvasContainer.dragging {
            cursor: grabbing;
        }

        canvas {
            display: block;
            touch-action: none;
        }

        .modalButtons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .modalButton {
            background-color: #FFD700;
            color: #0A0A0A;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }

        .modalButton:hover {
            background-color: #FFC400;
        }

        .modalButton.cancel {
            background-color: #555;
            color: #FFF;
        }

        .modalButton.cancel:hover {
            background-color: #777;
        }

        /* Styles for Zoom Controls */
        .zoomControls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
        }
        .zoomButton {
            background-color: #3A3A3A;
            color: #FFD700;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid #FFD700;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .zoomButton:hover {
            background-color: #4A4A4A;
        }

        /* New styles for all campaigns list */
        .allCampaignsList {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        .allCampaignsListItem {
            background-color: #2A2A2A;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: flex-start; /* Align items to the top */
            cursor: pointer; /* Pointer to indicate clickable for the whole card */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .allCampaignsListItem:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
        }
        .campaignListImagePlaceholder { /* New class for the image/button container */
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 15px;
            flex-shrink: 0;
            background-color: #3A3A3A; /* Background for the placeholder/button */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative; /* For the button text */
            overflow: hidden; /* To handle background image overflow if it's large */
            background-size: cover; /* Make background image cover the area */
            background-position: center; /* Center the background image */
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5); /* Subtle inner shadow */
        }
        .campaignListProjectButton { /* New class for the actual clickable button inside */
            background-color: rgba(255, 215, 0, 0.8); /* Semi-transparent gold */
            color: #0A0A0A;
            padding: 5px 8px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease;
            position: absolute; /* Position over the background image */
            bottom: 5px; /* Place it at the bottom */
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap; /* Prevent text wrapping */
            text-shadow: 0 0 3px rgba(0,0,0,0.5);
            line-height: 1; /* Adjust line height for smaller button */
        }
        .campaignListProjectButton:hover {
            background-color: #FFC400; /* Solid gold on hover */
        }

        .campaignListContent {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .campaignListTitle {
            font-size: 16px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }
        .campaignListCreator {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #CCC;
            margin-bottom: 8px;
        }
        .campaignListCreatorProfilePic {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 8px;
            border: 1px solid #FFD700; /* Small border for visibility */
        }
        .campaignListDescription {
            font-size: 13px;
            color: #AAA;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Show only 2 lines */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 10px;
        }
        .campaignListStats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #CCC;
            width: 100%;
        }
        .campaignListGoal, .campaignListRaised {
            font-weight: bold;
            color: #FFF;
        }
        .fee-info-container {
            position: relative;
            display: inline-flex; /* To keep icon next to text */
            align-items: center;
            margin-left: 5px; /* Space from the "Raised" text */
        }
        .fee-info-icon {
            font-size: 10px; /* Smaller icon */
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: #FFD700;
            color: #0A0A0A;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
        }
        .fee-info-tooltip {
            position: absolute;
            bottom: 100%; /* Position above the icon */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: #FFF;
            padding: 8px;
            border-radius: 5px;
            font-size: 10px;
            white-space: normal; /* Allow text to wrap */
            width: 180px; /* Fixed width for tooltip */
            text-align: left;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            pointer-events: none; /* Allow clicks to pass through */
            z-index: 10; /* Ensure it's above other elements */
            margin-bottom: 5px; /* Space between icon and tooltip */
        }
        .fee-info-container:hover .fee-info-tooltip {
            opacity: 1;
            visibility: visible;
        }


        /* Campaign Details Screen Specific Styles */
        .campaignDetailHeader {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .campaignDetailImage {
            width: 100%;
            max-width: 350px; /* Max width for images */
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        /* Style to hide image if it fails to load */
        .campaignDetailImage.hidden {
            display: none;
        }

        .campaignDetailTitle {
            font-size: 22px;
            font-weight: bold;
            color: #FFD700;
            text-align: center;
            margin-bottom: 10px;
        }
        .campaignDetailCreator {
            display: flex;
            align-items: center;
            font-size: 15px;
            color: #CCC;
            margin-bottom: 15px;
        }
        .campaignDetailCreatorProfilePic {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            border: 2px solid #FFD700;
        }
        .campaignDetailDescription {
            font-size: 14px;
            color: #AAA;
            line-height: 1.6;
            margin-bottom: 20px;
            background-color: #1A1A1A;
            padding: 15px;
            border-radius: 10px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
        }
        .campaignDetailStats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 20px;
            padding: 10px 0;
            border-top: 1px solid #333;
            border-bottom: 1px solid #333;
        }
        .campaignDetailStatItem {
            text-align: center;
            font-size: 14px;
            color: #CCC;
        }
        .campaignDetailStatValue {
            font-size: 18px;
            font-weight: bold;
            color: #FFF;
        }
        .campaignDetailProgressBarContainer {
            width: 80%;
            background-color: #444;
            border-radius: 5px;
            height: 12px;
            margin-bottom: 10px;
            overflow: hidden;
            align-self: center; /* Center the progress bar */
        }
        .campaignDetailProgressBar {
            height: 100%;
            background-color: #FFD700;
            border-radius: 5px;
        }

        /* Admin Dashboard Specific Styles */
        .adminActionButton {
            background-color: #FFD700;
            color: #0A0A0A;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            margin-left: 10px;
            transition: background-color 0.2s ease;
        }
        .adminActionButton.approve {
            background-color: #008000; /* Green for approve */
            color: #FFF;
        }
        .adminActionButton.reject {
            background-color: #DC3545; /* Red for reject */
            color: #FFF;
        }
        .adminActionButton:hover {
            filter: brightness(1.1);
        }
        .adminActionButton.approve:hover {
            background-color: #006400;
        }
        .adminActionButton.reject:hover {
            background-color: #C82333;
        }
        .adminDashboardItem {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #3A3A3A;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            color: #FFF;
            font-size: 14px;
        }
        .adminDashboardItemTitle {
            flex-grow: 1;
            font-weight: bold;
        }
        .adminDashboardItemStatus {
            font-size: 12px;
            margin-left: 10px;
            color: #FFD700; /* Default for pending */
        }
        .adminDashboardItemStatus.active {
            color: #00FF00;
        }
        .adminDashboardItemStatus.rejected {
            color: #DC3545;
        }

        /* Confirmation Modal Styles */
        .confirmationModalOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Higher than any other modal */
        }

        .confirmationModalContent {
            background-color: #1A1A1A;
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
            text-align: center;
            color: #FFF;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .confirmationModalTitle {
            font-size: 20px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
        }

        .confirmationModalMessage {
            font-size: 15px;
            color: #CCC;
            line-height: 1.5;
        }

        .confirmationModalButtons {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            margin-top: 15px;
        }

        .confirmationButton {
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
            flex-grow: 1;
        }

        .confirmationButton.confirm {
            background-color: #008000; /* Green for confirm */
            color: #FFF;
        }

        .confirmationButton.confirm:hover {
            background-color: #006400;
        }

        .confirmationButton.cancel {
            background-color: #DC3545; /* Red for cancel */
            color: #FFF;
        }

        .confirmationButton.cancel:hover {
            background-color: #C82333;
        }

        .admin-toggle-button:hover {
            background-color: #FFC400; /* Slightly darker gold on hover */
            transform: scale(1.05); /* Slight scale effect on hover */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5); /* Enhanced shadow on hover */
        }

        /* New styles for Upload Progress Bar */
        .uploadProgressContainer {
            width: 100%;
            background-color: #444;
            border-radius: 5px;
            height: 12px;
            margin-top: 15px;
            overflow: hidden;
        }
        .uploadProgressBar {
            height: 100%;
            background-color: #008000; /* Green for progress */
            border-radius: 5px;
            transition: width 0.2s ease-in-out;
            text-align: center;
            line-height: 12px;
            font-size: 10px;
            color: #FFF;
            font-weight: bold;
        }


                /* NEW STYLES for User Search Screen */
        .user-search-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        .user-search-item {
            background-color: #2A2A2A;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
        }
        .user-search-pfp {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #FFD700;
        }
        .user-search-info {
            flex-grow: 1;
        }
        .user-search-name {
            font-size: 16px;
            font-weight: bold;
            color: #FFF;
        }
        .user-search-role {
            font-size: 12px;
            color: #AAA;
        }
        .user-search-campaign-badge {
            background-color: #00FF00;
            color: #0A0A0A;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 10px;
        }
        /* NEW STYLES for Creator Dashboard Campaign List */
        .creator-campaign-list-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background-color: #3A3A3A;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .creator-campaign-thumbnail {
            width: 80px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
        }
        .creator-campaign-info {
            flex-grow: 1;
        }
        .creator-campaign-title {
            font-size: 14px;
            font-weight: bold;
            color: #FFF;
        }
        .creator-campaign-status {
            font-size: 12px;
        }
        .status-pending { color: #FFD700; }
        .status-active { color: #00FF00; }
        .status-rejected { color: #DC3545; }
        .status-ended { color: #888; }
        .status-cancelled { color: #AAA; }

         /* START: New Carousel Navigation Button Styles */
        .carousel-wrapper {
            position: relative; /* Establishes a positioning context for the buttons */
            width: 100%;
        }

        .carousel-nav-btn {
            position: absolute;
            z-index: 10;
            background-color: rgba(10, 10, 10, 0.6); /* Semi-transparent dark background */
            color: #FFD700; /* Gold icon color */
            border: 1px solid #FFD700;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-size: 20px; /* Adjust size of arrow characters */
            line-height: 1; /* Ensure vertical centering of arrows */
        }

        .carousel-nav-btn:hover {
            background-color: rgba(255, 215, 0, 0.8); /* Semi-transparent gold on hover */
            color: #0A0A0A; /* Dark icon color on hover */
            transform: scale(1.1);
        }

        /* Positioning for Horizontal Carousel Buttons */
        .carousel-nav-btn.prev-horizontal {
            top: 50%;
            left: 5px;
            transform: translateY(-50%);
        }

        .carousel-nav-btn.next-horizontal {
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
        }

        /* Positioning for Vertical Carousel Buttons */
        .carousel-nav-btn.prev-vertical {
            left: 50%;
            top: 5px;
            transform: translateX(-50%);
        }

        .carousel-nav-btn.next-vertical {
            left: 50%;
            bottom: 5px;
            transform: translateX(-50%);
        }
        /* END: New Carousel Navigation Button Styles */

    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 1. Initialize Firebase SDKs (module type) - Must be loaded before React components that use them -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, orderBy, onSnapshot, where, getDocs, deleteDoc, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Global Firebase variables (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBo3DM-4ZwrZdzcYQAMWAVHu70vWUdB7J4",
            authDomain: "nvanetworkapp.firebaseapp.com",
            projectId: "nvanetworkapp",
            storageBucket: "nvanetworkapp.firebasestorage.app",
            messagingSenderId: "122220543439",
            appId: "1:122220543439:web:e36ccce435463b7939a6ba",
            measurementId: "G-6RNS6DH3G0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); // Initialize Storage
        const analytics = getAnalytics(app);

        // Export for use in React component
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseStorage = storage; // Export Storage
        window.initialAuthToken = initialAuthToken; // Export corrected initialAuthToken
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword; // Expose the function itself
        window.signInWithEmailAndPassword = signInWithEmailAndPassword; // Expose sign-in function
        window.signOut = signOut; // Expose sign-out function
        window.onAuthStateChanged = onAuthStateChanged; // Expose auth state listener
        window.doc = doc; // Expose Firestore doc
        window.setDoc = setDoc; // Expose Firestore setDoc
        window.getDoc = getDoc; // Expose Firestore getDoc
        window.updateDoc = updateDoc; // Expose Firestore updateDoc
        window.collection = collection; // Expose Firestore collection
        window.addDoc = addDoc; // Expose Firestore addDoc
        window.query = query; // Expose Firestore query
        window.orderBy = orderBy; // Expose Firestore orderBy
        window.onSnapshot = onSnapshot; // Expose Firestore onSnapshot
        window.where = where; // Expose where for Firestore queries
        window.getDocs = getDocs; // Expose getDocs for Firestore queries
        window.deleteDoc = deleteDoc; // Expose deleteDoc for Firestore
        window.ref = ref;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
        window.appId = appId;
        window.signInWithCustomToken = signInWithCustomToken; // Expose signInWithCustomToken
        window.signInAnonymously = signInAnonymously; // Expose signInAnonymously

        window.limit = limit;

        
    </script>

    <!-- 2. Load React and ReactDOM (synchronously, no defer) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- 3. Load Babel (synchronously, to process JSX from the next script) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Define your React App component (JSX content here) -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const auth = window.firebaseAuth;
        const db = window.firebaseDb;
        const storage = window.firebaseStorage;
        const createUserWithEmailAndPassword = window.createUserWithEmailAndPassword;
        const signInWithEmailAndPassword = window.signInWithEmailAndPassword;
        const signOut = window.signOut;
        const onAuthStateChanged = window.onAuthStateChanged;
        const doc = window.doc;
        const setDoc = window.setDoc;
        const getDoc = window.getDoc;
        const updateDoc = window.updateDoc;
        const collection = window.collection;
        const addDoc = window.addDoc;
        const query = window.query;
        const orderBy = window.orderBy;
        const onSnapshot = window.onSnapshot;
        const where = window.where; // Added where for Firestore queries
        const getDocs = window.getDocs; // Added getDocs for Firestore queries
        const deleteDoc = window.deleteDoc; // Added deleteDoc for Firestore
        const ref = window.ref;
        const uploadBytes = window.uploadBytes;
        const getDownloadURL = window.getDownloadURL;
        const appId = window.appId;
        const signInAnonymously = window.signInAnonymously; // Import signInAnonymously


        const limit = window.limit;
        

        // Hardcoded content - these will eventually be replaced by dynamic data from Firestore
        const featuredContent = [
            { id: '1', title: 'Guyanese Comedy Special', type: 'skit', url: 'https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1', creator: 'Comedy Crew' },
            { id: '2', title: 'Top Guyanese Skits: Best of 2024', type: 'skit', url: 'https://www.youtube.com/embed/oHg5SJYRHA0?autoplay=1', creator: 'Laugh Central' },
            { id: '3', title: 'Indie Film: "Georgetown Dreams"', type: 'short-film', url: 'https://www.youtube.com/embed/34Na4j8AVgA?autoplay=1', creator: 'Indie Films GY' },
            { id: '4', title: 'Live Concert Replay: Mashramani', type: 'live-premiere', url: 'https://www.youtube.com/embed/example4?autoplay=1', creator: 'Vibes Ent.' },
            { id: '5', title: 'Creator Interview: Rise of Talent', type: 'interview', url: 'https://www.youtube.com/embed/example5?autoplay=1', creator: 'NVA Insights' },
            { id: '6', title: 'Short Film: "The Golden Arrowhead"', type: 'short-film', url: 'https://www.youtube.com/embed/example6?autoplay=1', creator: 'Heritage Films' },
            { id: '7', title: 'New Skit Series: "Life in GT"', type: 'skit', url: 'https://www.youtube.com/embed/skit7?autoplay=1', creator: 'GT Daily' },
            { id: '8', title: 'Cooking Show: Guyanese Delights', type: 'skit', url: 'https://www.youtube.com/embed/skit8?autoplay=1', creator: 'Chef Roti' },
            { id: '9', title: 'Poetry Slam Live: Best of Season', type: 'live-premiere', url: 'https://www.youtube.com/embed/live9?autoplay=1', creator: 'Wordsmiths GY' },
            { id: '10', title: 'Wildlife Doc: Amazonian Secrets', type: 'documentary', url: 'https://www.youtube.com/embed/doc1?autoplay=1', creator: 'Nature Watch' },
            { id: '11', title: 'Guyanese Music Spotlight', type: 'music', url: 'https://www.youtube.com/embed/music1?autoplay=1', creator: 'Riddim Connect' },
            { id: '12', title: 'Interview: Young Entrepreneurs', type: 'interview', url: 'https://www.youtube.com/embed/int1?autoplay=1', creator: 'Business Buzz GY' },
        ];


 

        const getYouTubeEmbedUrl = (youtubeUrl) => {
            const videoIdMatch = youtubeUrl.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/||shorts\/))([^&?#]+)/);
            if (videoIdMatch && videoIdMatch[1]) {
                return `https://www.youtube.com/embed/${videoIdMatch[1]}?autoplay=1&rel=0`;
            }
            return youtubeUrl;
        };

        const VideoPlayerModal = ({ videoUrl, onClose }) => {
            if (!videoUrl) return null;

            // Use the new, more powerful helper function
            const { embedUrl, isVertical } = extractVideoInfo(videoUrl);

            // Fallback for URLs that cannot be parsed into an embed link
            const finalEmbedUrl = embedUrl || (videoUrl.includes('?') ? `${videoUrl}&autoplay=1` : `${videoUrl}?autoplay=1`);

            return (
                <div className="videoModalOverlay">
                    {/* Conditionally add the 'vertical' class for vertical videos */}
                    <div className={`videoModalContent ${isVertical ? 'vertical' : ''}`}>
                        <button className="closeButton" onClick={onClose}></button>
                        {/* Also add the 'vertical' class to the iframe container */}
                        <div className={`videoIframeContainer ${isVertical ? 'vertical' : ''}`}>
                            <iframe
                                src={finalEmbedUrl}
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                allowFullScreen
                                title="Embedded Video Content"
                            ></iframe>
                        </div>
                    </div>
                </div>
            );
        };


                // --- START OF NEW COMPONENT ---
        // --- START: REPLACEMENT FOR DiscoverUsersScreen ---
        const DiscoverUsersScreen = ({ showMessage, setActiveScreen, setSelectedCampaignId, creatorProfile, setSelectedUserId }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [hasSearched, setHasSearched] = useState(false);
            
            const viewProfile = (userId) => {
                setSelectedUserId(userId);
                setActiveScreen('UserProfile');
            };

            const handleSearch = async (e) => {
                e.preventDefault();
                if (!searchTerm.trim()) { setSearchResults([]); return; }
                setIsLoading(true);
                setHasSearched(true);
                
                try {
                    const usersRef = collection(db, "creators");
                    let q;

                    if (creatorProfile && (creatorProfile.role === 'admin' || creatorProfile.role === 'authority')) {
                        q = query(usersRef);
                    } else {
                        q = query(usersRef, where('role', 'in', ['user', 'creator']));
                    }
                    
                    const querySnapshot = await getDocs(q);
                    const users = querySnapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(user => user.creatorName && user.creatorName.toLowerCase().includes(searchTerm.toLowerCase()));

                    const usersWithCampaignStatus = await Promise.all(
                        users.map(async (user) => {
                            const campaignsRef = collection(db, `artifacts/${appId}/public/data/campaigns`);
                            const campaignQuery = query(campaignsRef, where('creatorId', '==', user.id), where('status', '==', 'active'));
                            const campaignSnapshot = await getDocs(campaignQuery);
                            return {
                                ...user,
                                hasActiveCampaign: !campaignSnapshot.empty,
                                activeCampaignId: !campaignSnapshot.empty ? campaignSnapshot.docs[0].id : null
                            };
                        })
                    );
                    setSearchResults(usersWithCampaignStatus);
                } catch (error) {
                    console.error("Error searching users:", error);
                    showMessage("Failed to search for users. Please try again.");
                } finally {
                    setIsLoading(false);
                }
            };
            
            return (
                <div className="screenContainer">
                    <p className="heading">Discover Creators</p>
                    <form onSubmit={handleSearch}>
                        <div className="formGroup">
                            <label htmlFor="userSearch" className="formLabel">Creator Name:</label>
                            <input type="text" id="userSearch" className="formInput" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Enter a creator's name..."/>
                        </div>
                        <button type="submit" className="button" disabled={isLoading}><span className="buttonText">{isLoading ? 'Searching...' : 'Search'}</span></button>
                    </form>
                    <div className="user-search-list">
                        {isLoading && <p>Searching...</p>}
                        {!isLoading && hasSearched && searchResults.length === 0 && <p>No users found matching "{searchTerm}".</p>}
                        {!isLoading && searchResults.map(user => (
                            <div key={user.id} className="user-search-item" style={{cursor: 'pointer'}} onClick={() => viewProfile(user.id)}>
                                <img src={user.profilePictureUrl || 'https://placehold.co/100x100/555/FFF?text=P'} alt={user.creatorName} className="user-search-pfp"/>
                                <div className="user-search-info">
                                    <p className="user-search-name">
                                        {user.creatorName}
                                        {user.hasActiveCampaign && <span className="user-search-campaign-badge">Active Campaign</span>}
                                    </p>
                                    <p className="user-search-role">Role: {user.role}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        // --- END OF REPLACEMENT ---


        const UserProfileScreen = ({ selectedUserId, setActiveScreen, setSelectedCampaignId, showMessage }) => {
            const [profile, setProfile] = useState(null);
            const [campaigns, setCampaigns] =useState([]);
            const [loading, setLoading] = useState(true);
            
            // State to manage the video player modal locally within this component
            const [showVideoModal, setShowVideoModal] = useState(false);
            const [currentVideoUrl, setCurrentVideoUrl] = useState('');

            useEffect(() => {
                if (!selectedUserId) {
                    setActiveScreen('DiscoverUsers');
                    return;
                }

                const fetchProfileData = async () => {
                    setLoading(true);
                    try {
                        // 1. Fetch user profile document
                        const userDocRef = doc(db, "creators", selectedUserId);
                        const userDocSnap = await getDoc(userDocRef);
                        
                        if (userDocSnap.exists()) {
                            setProfile(userDocSnap.data());
                        } else {
                            showMessage("This user profile could not be found.");
                            setActiveScreen('DiscoverUsers');
                            return;
                        }

                        // 2. Fetch user's active campaigns
                        const campaignsRef = collection(db, `artifacts/${appId}/public/data/campaigns`);
                        const q = query(campaignsRef, where('creatorId', '==', selectedUserId), where('status', '==', 'active'));
                        const campaignSnapshot = await getDocs(q);
                        const userCampaigns = campaignSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setCampaigns(userCampaigns);

                    } catch (error) {
                        console.error("Error fetching user profile:", error);
                        showMessage("Failed to load user profile.");
                        setActiveScreen('DiscoverUsers');
                    } finally {
                        setLoading(false);
                    }
                };

                fetchProfileData();
            }, [selectedUserId]);
            
            const handleVideoPress = (url) => {
                setCurrentVideoUrl(url);
                setShowVideoModal(true);
            };

            const closeVideoModal = () => {
                setShowVideoModal(false);
                setCurrentVideoUrl('');
            };


            if (loading) {
                return (<div className="screenContainer" style={{ textAlign: 'center', paddingTop: '50px' }}><p className="heading">Loading Profile...</p></div>);
            }

            if (!profile) return null;

            return (
                <>
                    <div className="screenContainer">
                        {/* --- Profile Details Section --- */}
                        <div className="dashboardSection">
                            <div className="flex items-center mb-4">
                                <img 
                                    src={profile.profilePictureUrl || 'https://placehold.co/100x100/555/FFF?text=P'} 
                                    alt="Profile" 
                                    style={{width: '100px', height: '100px', borderRadius: '50%', border: '2px solid #FFD700', objectFit: 'cover'}} 
                                />
                                <div style={{marginLeft: '1rem'}}>
                                    <p className="dashboardItem" style={{fontSize: '20px', fontWeight: 'bold', color: '#FFF', marginBottom: '5px'}}>{profile.creatorName}</p>
                                    <p className="dashboardItem" style={{fontSize: '14px', color: '#AAA'}}>Role: {profile.role}</p>
                                </div>
                            </div>
                            <p className="dashboardItem" style={{marginTop: '15px'}}><strong>Bio:</strong> {profile.bio || "No bio provided."}</p>
                            <p className="dashboardItem"><strong>Categories:</strong> {profile.categories?.length > 0 ? profile.categories.join(', ') : "No categories set."}</p>
                            <p className="dashboardItem">
                                <strong>External Link:</strong> {profile.existingWorkLink ? 
                                    <a href={profile.existingWorkLink} target="_blank" rel="noopener noreferrer" className="termsLink">{profile.existingWorkLink}</a> 
                                    : "No link provided."}
                            </p>
                        </div>

                        {/* --- Featured Link Section --- */}
                        <div className="dashboardSection">
                            <p className="dashboardSectionTitle">Featured Content</p>
                            {profile.featuredVideoLink && profile.featuredVideoLink.url ? (
                                <div 
                                    className="vertical-carousel-item" 
                                    style={{cursor: 'pointer'}} 
                                    onClick={() => handleVideoPress(profile.featuredVideoLink.embedUrl || profile.featuredVideoLink.url)}
                                >
                                    <img src={profile.featuredVideoLink.thumbnailUrl || 'https://placehold.co/80x60/3A3A3A/FFF?text=Video'} alt="Featured Video" className="liveFeedThumbnail" />
                                    <div className="liveFeedContent">
                                        <p className="liveFeedTitle">Latest from {profile.creatorName}</p>
                                        <p className="liveFeedCreator" style={{color: '#FFD700'}}>Click to watch</p>
                                    </div>
                                </div>
                            ) : (
                                <p className="dashboardItem">This creator has not featured any content.</p>
                            )}
                        </div>

                        {/* --- Active Campaigns Section --- */}
                        <div className="dashboardSection">
                            <p className="dashboardSectionTitle">Active Crowdfunding Campaigns</p>
                            {campaigns.length > 0 ? (
                                campaigns.map(campaign => (
                                    <div 
                                        key={campaign.id} 
                                        className="creator-campaign-list-item" 
                                        style={{cursor: 'pointer'}} 
                                        onClick={() => {
                                            setSelectedCampaignId(campaign.id);
                                            setActiveScreen('CampaignDetails');
                                        }}
                                    >
                                        <img src={campaign.imageUrl || 'https://placehold.co/80x50/3A3A3A/FFF?text=NVA'} alt={campaign.title} className="creator-campaign-thumbnail" />
                                        <div className="creator-campaign-info">
                                            <p className="creator-campaign-title">{campaign.title}</p>
                                            <p className="creator-campaign-status status-active">Click to view campaign</p>
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <p className="dashboardItem">This creator does not have any active campaigns.</p>
                            )}
                        </div>

                        <button className="button" onClick={() => setActiveScreen('DiscoverUsers')} style={{ backgroundColor: '#3A3A3A', color: '#FFF' }}>
                            <span className="buttonText">Back to Search</span>
                        </button>
                    </div>

                    {/* --- Video Player Modal controlled by local state --- */}
                    {showVideoModal && (
                        <VideoPlayerModal videoUrl={currentVideoUrl} onClose={closeVideoModal} />
                    )}
                </>
            );
        };
// =================== END: REPLACE THIS ENTIRE COMPONENT ===================


        // --- START: COMPLETE AND CORRECTED ProfilePictureAdjustModal ---
        const ProfilePictureAdjustModal = ({ imageUrl, onSave, onCancel, showMessage }) => {
            const canvasRef = useRef(null);
            const imageRef = useRef(new Image());
            const [scale, setScale] = useState(1);
            const [position, setPosition] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

            const canvasSize = 200;
            const profilePicSize = 300; // The final output size of the profile picture

            const drawImage = useCallback(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const img = imageRef.current;

                if (!img.complete || img.naturalWidth === 0) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    return;
                }
                
                // Clear and set background
                ctx.fillStyle = '#333';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Save context state
                ctx.save();
                
                // Apply scaling for high-DPI displays
                const devicePixelRatio = window.devicePixelRatio || 1;
                ctx.scale(devicePixelRatio, devicePixelRatio);

                // Clip to a circle
                ctx.beginPath();
                ctx.arc(canvasSize / 2, canvasSize / 2, canvasSize / 2, 0, Math.PI * 2, true);
                ctx.clip();

                const scaledWidth = img.naturalWidth * scale;
                const scaledHeight = img.naturalHeight * scale;
                
                // Draw the image with current position and scale
                ctx.drawImage(img, position.x, position.y, scaledWidth, scaledHeight);
                
                // Restore context state
                ctx.restore();

            }, [scale, position, canvasSize]);
            
            useEffect(() => {
                const canvas = canvasRef.current;
                if (canvas) {
                    // Adjust canvas for high-DPI displays
                    const devicePixelRatio = window.devicePixelRatio || 1;
                    canvas.width = canvasSize * devicePixelRatio;
                    canvas.height = canvasSize * devicePixelRatio;
                    canvas.style.width = `${canvasSize}px`;
                    canvas.style.height = `${canvasSize}px`;
                }
            }, [canvasSize]);

            useEffect(() => {
                const img = imageRef.current;
                img.crossOrigin = 'anonymous';
                img.src = imageUrl;

                img.onload = () => {
                    // Initial scale to fit the image inside the circle
                    const initialScale = Math.min(canvasSize / img.naturalWidth, canvasSize / img.naturalHeight);
                    setScale(initialScale);
                    
                    // Center the image
                    const initialX = (canvasSize - img.naturalWidth * initialScale) / 2;
                    const initialY = (canvasSize - img.naturalHeight * initialScale) / 2;
                    setPosition({ x: initialX, y: initialY });
                };
                img.onerror = () => { showMessage("Failed to load image for adjustment."); };
            }, [imageUrl, showMessage, canvasSize]);

            useEffect(() => {
                drawImage();
            }, [scale, position, drawImage]);
            
            // --- Event Handlers for Panning and Zooming ---
            const handleMouseDown = (e) => {
                setIsDragging(true);
                setDragStart({ x: e.clientX - position.x, y: e.clientY - position.y });
            };
            const handleMouseMove = (e) => {
                if (!isDragging) return;
                setPosition({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y });
            };
            const handleMouseUp = () => setIsDragging(false);
            const handleMouseLeave = () => setIsDragging(false);
            
            const handleWheel = (e) => {
                e.preventDefault();
                const zoomFactor = e.deltaY < 0 ? 1.1 : 0.9;
                const newScale = scale * zoomFactor;
                
                const rect = canvasRef.current.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                const newPosition = {
                    x: mouseX - (mouseX - position.x) * zoomFactor,
                    y: mouseY - (mouseY - position.y) * zoomFactor
                };
                
                setScale(newScale);
                setPosition(newPosition);
            };

            // --- FULLY IMPLEMENTED SAVE FUNCTION ---
            const saveCroppedImage = () => {
                const img = imageRef.current;
                if (!img.complete || img.naturalWidth === 0) {
                    showMessage("Image not loaded for saving.");
                    return;
                }

                const outputCanvas = document.createElement('canvas');
                outputCanvas.width = profilePicSize;
                outputCanvas.height = profilePicSize;
                const ctx = outputCanvas.getContext('2d');

                ctx.beginPath();
                ctx.arc(profilePicSize / 2, profilePicSize / 2, profilePicSize / 2, 0, Math.PI * 2, true);
                ctx.clip();
                
                // Calculate how to draw the panned/zoomed image onto the new canvas
                const finalScale = scale * (profilePicSize / canvasSize);
                const finalX = position.x * (profilePicSize / canvasSize);
                const finalY = position.y * (profilePicSize / canvasSize);

                ctx.drawImage(img, finalX, finalY, img.naturalWidth * finalScale, img.naturalHeight * finalScale);
                
                outputCanvas.toBlob((blob) => {
                    if (blob) {
                        onSave(blob);
                    } else {
                        showMessage("Failed to create image file.");
                    }
                }, 'image/png', 0.9);
            };

            return (
                <div className="imageAdjustModalOverlay">
                    <div className="imageAdjustModalContent">
                        <p className="heading" style={{fontSize: '20px', marginBottom: '10px'}}>Adjust Profile Picture</p>
                        <p className="subHeading" style={{fontSize: '14px', marginBottom: '15px', color: '#CCC'}}>Drag to pan, scroll to zoom.</p>
                        <div
                            className={`canvasContainer ${isDragging ? 'dragging' : ''}`}
                            onMouseDown={handleMouseDown}
                            onMouseMove={handleMouseMove}
                            onMouseUp={handleMouseUp}
                            onMouseLeave={handleMouseLeave}
                            onWheel={handleWheel}
                        >
                            <canvas ref={canvasRef}></canvas>
                        </div>
                        <div className="modalButtons">
                            <button className="modalButton" onClick={saveCroppedImage}>Save</button>
                            <button className="modalButton cancel" onClick={onCancel}>Cancel</button>
                        </div>
                    </div>
                </div>
            );
        };
        // --- END: COMPLETE AND CORRECTED ProfilePictureAdjustModal

        // --- REPLACEMENT COMPONENT ---
        const CreateCampaignScreen = ({ showMessage, setActiveScreen, currentUser, creatorProfile }) => {
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [goal, setGoal] = useState('');
            const [projectLink, setProjectLink] = useState(''); // Changed from imageUrl

            // New state for thumbnail handling
            const [customThumbnailFile, setCustomThumbnailFile] = useState(null);
            const [customThumbnailPreview, setCustomThumbnailPreview] = useState('');
            const [autoThumbnailPreview, setAutoThumbnailPreview] = useState('');
            const [isUploading, setIsUploading] = useState(false);
            const thumbnailInputRef = useRef(null);

            // Effect to auto-fetch thumbnail from project link
            useEffect(() => {
                if (!projectLink) {
                    setAutoThumbnailPreview('');
                    return;
                }
                const handler = setTimeout(() => {
                    const { thumbnailUrl } = extractVideoInfo(projectLink);
                    if (thumbnailUrl) {
                        setAutoThumbnailPreview(thumbnailUrl);
                    } else {
                        setAutoThumbnailPreview(''); // Clear if no thumbnail found
                    }
                }, 800); // Debounce to avoid fetching on every keystroke

                return () => clearTimeout(handler);
            }, [projectLink]);

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setCustomThumbnailFile(file);
                    setCustomThumbnailPreview(URL.createObjectURL(file));
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsUploading(true);

                if (!title || !description || !goal) {
                    showMessage('Please fill in all required fields: Title, Description, and Funding Goal.');
                    setIsUploading(false);
                    return;
                }
                if (isNaN(goal) || parseFloat(goal) <= 0) {
                    showMessage('Funding Goal must be a positive number.');
                    setIsUploading(false);
                    return;
                }

                // Check for existing active campaigns
                const campaignsCollectionRef = collection(db, `artifacts/${appId}/public/data/campaigns`);
                const q = query(campaignsCollectionRef, where('creatorId', '==', currentUser.uid), where('status', '==', 'active'));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    showMessage('You can only have one active crowdfunding campaign at a time.');
                    setIsUploading(false);
                    return;
                }

                let finalImageUrl = autoThumbnailPreview || ''; // Default to auto-fetched thumbnail

                // If a custom thumbnail is provided, upload it first.
                if (customThumbnailFile) {
                    showMessage("Uploading custom thumbnail...");
                    try {
                        const filePath = `campaign_thumbnails/${currentUser.uid}/${Date.now()}_${customThumbnailFile.name}`;
                        const storageRef = ref(storage, filePath);
                        const snapshot = await uploadBytes(storageRef, customThumbnailFile);
                        finalImageUrl = await getDownloadURL(snapshot.ref);
                        showMessage("Thumbnail uploaded successfully!");
                    } catch (error) {
                        console.error("Error uploading campaign thumbnail:", error);
                        showMessage(`Thumbnail upload failed: ${error.message}`);
                        setIsUploading(false);
                        return;
                    }
                }

                try {
                    const createdAt = new Date();
                    const endDate = new Date(createdAt);
                    endDate.setDate(createdAt.getDate() + 30); // Campaigns run for 30 days

                    await addDoc(campaignsCollectionRef, {
                        creatorId: currentUser.uid,
                        creatorName: creatorProfile.creatorName || currentUser.email,
                        creatorProfilePictureUrl: creatorProfile.profilePictureUrl || '',
                        title,
                        description,
                        goal: parseFloat(goal),
                        raised: 0,
                        projectLink: projectLink, // The actual link to the project/video
                        imageUrl: finalImageUrl, // The URL of the thumbnail image
                        createdAt: createdAt.toISOString(),
                        endDate: endDate.toISOString(),
                        status: 'pending' // All campaigns start as pending
                    });

                    showMessage(`Campaign "${title}" submitted for review!`);
                    setActiveScreen('CreatorDashboard');
                } catch (error) {
                    console.error("Error creating campaign:", error);
                    showMessage(`Failed to create campaign: ${error.message}.`);
                } finally {
                    setIsUploading(false);
                }
            };
            
            // Determine which preview to show
            const currentPreview = customThumbnailPreview || autoThumbnailPreview;

            return (
                <div className="screenContainer">
                    <p className="heading">Create New Campaign</p>
                    <p className="subHeading">Tell us about your project. It will be reviewed before going live.</p>
                    
                    <form onSubmit={handleSubmit}>
                        <div className="formGroup">
                            <label htmlFor="campaignTitle" className="formLabel">Campaign Title:</label>
                            <input type="text" id="campaignTitle" className="formInput" value={title} onChange={(e) => setTitle(e.target.value)} required />
                        </div>

                        <div className="formGroup">
                            <label htmlFor="campaignDescription" className="formLabel">Description:</label>
                            <textarea id="campaignDescription" className="formTextarea" value={description} onChange={(e) => setDescription(e.target.value)} placeholder="Describe your project, what you need funding for, etc." required></textarea>
                        </div>

                        <div className="formGroup">
                            <label htmlFor="campaignGoal" className="formLabel">Funding Goal (USD):</label>
                            <input type="number" id="campaignGoal" className="formInput" value={goal} onChange={(e) => setGoal(e.target.value)} min="1" step="any" required />
                        </div>

                        <div className="formGroup">
                            <label htmlFor="projectLink" className="formLabel">Project Link (Optional):</label>
                            <input type="url" id="projectLink" className="formInput" value={projectLink} onChange={(e) => setProjectLink(e.target.value)} placeholder="e.g., YouTube, Facebook video link" />
                            <p className="smallText" style={{textAlign: 'left', color: '#AAA', marginTop: '5px'}}>We'll try to generate a thumbnail from this link.</p>
                        </div>

                        <div className="formGroup">
                            <label className="formLabel">Campaign Thumbnail:</label>
                            {currentPreview && (
                                <div style={{ marginBottom: '15px' }}>
                                    <img src={currentPreview} alt="Thumbnail Preview" style={{ maxWidth: '100%', borderRadius: '8px', border: '2px solid #FFD700' }} />
                                </div>
                            )}
                            <input type="file" ref={thumbnailInputRef} onChange={handleFileChange} accept="image/*" style={{ display: 'none' }} />
                            <button type="button" className="button" onClick={() => thumbnailInputRef.current.click()} style={{ width: '100%', backgroundColor: '#3A3A3A' }}>
                                <span className="buttonText">{customThumbnailFile ? 'Change' : 'Upload'} Custom Thumbnail</span>
                            </button>
                             <p className="smallText" style={{textAlign: 'center', color: '#AAA', marginTop: '5px'}}>Recommended size: 1280x720 pixels.</p>
                        </div>

                        <button type="submit" className="button" disabled={isUploading}>
                            <span className="buttonText">{isUploading ? 'Submitting...' : 'Submit for Review'}</span>
                        </button>
                    </form>

                    <button className="button" onClick={() => setActiveScreen('CreatorDashboard')} style={{ backgroundColor: '#555', marginTop: '20px' }}>
                        <span className="buttonText">Back to Dashboard</span>
                    </button>
                </div>
            );
        };
        // --- END OF REPLACEMENT COMPONENT ---

        const AllCampaignsScreen = ({ showMessage, setActiveScreen, setSelectedCampaignId }) => {
            const [campaigns, setCampaigns] = useState([]);
            const [loading, setLoading] = useState(true);
            const PLATFORM_FEE_PERCENTAGE = 0.07; // Define the platform fee as a constant

            useEffect(() => {
                const campaignsCollectionRef = collection(db, `artifacts/${appId}/public/data/campaigns`);
                const q = query(
                    campaignsCollectionRef,
                    where('status', '==', 'active'), // Only show active campaigns
                    orderBy('createdAt', 'desc')
                );

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedCampaigns = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setCampaigns(fetchedCampaigns);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching campaigns:", error);
                    showMessage("Failed to load campaigns. Please try again.");
                    setLoading(false);
                });

                return () => unsubscribe();
            }, []);


            if (loading) {
                return (
                    <div className="screenContainer" style={{ textAlign: 'center', paddingTop: '50px' }}>
                        <p className="heading">Loading Campaigns...</p>
                        <p className="subHeading" style={{ color: '#FFD700' }}>Please ensure you have an internet connection.</p>
                    </div>
                );
            }

            return (
                <div className="screenContainer">
                    <p className="heading">All Campaigns</p>
                    <p className="subHeading">Discover and support projects by Guyanese creators!</p>

                    {campaigns.length === 0 ? (
                        <p className="paragraph" style={{ textAlign: 'center', marginTop: '20px' }}>No active campaigns found yet.</p>
                    ) : (
                        <div className="allCampaignsList">
                            {campaigns.map(campaign => {
                                const isEnded = new Date(campaign.endDate) < new Date();
                                return (
                                    <div
                                        key={campaign.id}
                                        className="allCampaignsListItem"
                                        onClick={() => {
                                            setSelectedCampaignId(campaign.id);
                                            setActiveScreen('CampaignDetails');
                                        }}
                                    >
                                        <div
                                            className="campaignListImagePlaceholder"
                                            style={{ backgroundImage: campaign.imageUrl ? `url(${campaign.imageUrl})` : 'none' }}
                                            onError={(e) => { e.target.onerror = null; e.target.style.backgroundImage='none'; }} /* No background image on error */
                                        >
                                            <button
                                                className="campaignListProjectButton"
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    if (campaign.imageUrl) {
                                                        window.open(campaign.imageUrl, '_blank');
                                                    } else {
                                                        showMessage('No project link provided for this campaign.');
                                                    }
                                                }}
                                            >
                                                View Project
                                            </button>
                                        </div>
                                        <div className="campaignListContent">
                                            <p className="campaignListTitle">
                                                {campaign.title} {isEnded && <span style={{color: '#DC3545', fontSize: '12px'}}>(Ended)</span>}
                                            </p>
                                            <div className="campaignListCreator">
                                                <img
                                                    src={campaign.creatorProfilePictureUrl || 'https://placehold.co/100x100/555/FFF?text=Profile'}
                                                    alt={campaign.creatorName}
                                                    className="campaignListCreatorProfilePic"
                                                    onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/24x24/555/FFF?text=P'; }}
                                                />
                                                <span>by {campaign.creatorName}</span>
                                            </div>
                                            <p className="campaignListDescription">{campaign.description}</p>
                                            <div className="campaignProgressContainer" style={{ height: '8px', marginBottom: '5px' }}>
                                                <div
                                                    className="campaignProgressBar"
                                                    style={{ width: `${(campaign.raised / campaign.goal) * 100}%` }}
                                                ></div>
                                            </div>
                                            <div className="campaignListStats">
                                                <span>
                                                    Raised: <span className="campaignListRaised">${campaign.raised}</span>
                                                    <div className="fee-info-container">
                                                        <span className="fee-info-icon">i</span>
                                                        <div className="fee-info-tooltip">
                                                            The 'Raised' amount is the total collected. Creator receives {((1 - PLATFORM_FEE_PERCENTAGE) * 100).toFixed(0)}% of this total after the platform fee.
                                                        </div>
                                                    </div>
                                                </span>
                                                <span>Goal: <span className="campaignListGoal">${campaign.goal}</span></span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                    <button
                        className="button"
                        onClick={() => setActiveScreen('Support')}
                        style={{ backgroundColor: '#3A3A3A', color: '#FFF', marginTop: '30px' }}
                    >
                        <span className="buttonText">Back to Support Us</span>
                    </button>
                </div>
            );
        };

        const CampaignDetailsScreen = ({ showMessage, setActiveScreen, selectedCampaignId, currentUser }) => {
            const [campaign, setCampaign] = useState(null);
            const [loading, setLoading] = useState(true);
            const campaignImageRef = useRef(null); // Ref to the image element

            useEffect(() => {
                const fetchCampaignDetails = async () => {
                    if (!selectedCampaignId) {
                        showMessage("No campaign selected.");
                        setActiveScreen('AllCampaigns');
                        return;
                    }

                    try {
                        const campaignDocRef = doc(db, `artifacts/${appId}/public/data/campaigns`, selectedCampaignId);
                        const docSnap = await getDoc(campaignDocRef);

                        if (docSnap.exists()) {
                            setCampaign({ id: docSnap.id, ...docSnap.data() });
                        } else {
                            showMessage("Campaign not found.");
                            setActiveScreen('AllCampaigns');
                        }
                        setLoading(false);
                    } catch (error) {
                        console.error("Error fetching campaign details:", error);
                        showMessage("Failed to load campaign details. Please try again.");
                        setLoading(false);
                        setActiveScreen('AllCampaigns');
                    }
                };

                fetchCampaignDetails();
            }, [selectedCampaignId, setActiveScreen, showMessage]);

            const handleSupportCampaign = async () => {
                    if (!campaign) return;

                    // If user is not logged in, sign in anonymously
                    if (!auth.currentUser) {
                        try {
                            await signInAnonymously(auth);
                            // auth.currentUser will now be set to the anonymous user
                        } catch (error) {
                            console.error("Error signing in anonymously:", error);
                            showMessage(`Failed to sign in for donation: ${error.message}. Please try again.`);
                            return;
                        }
                    }

                    const isEnded = new Date(campaign.endDate) < new Date();
                    if (isEnded) {
                        showMessage("This campaign has ended and can no longer receive donations.");
                        return;
                    }
                    if (campaign.status !== 'active') {
                        showMessage("This campaign is not yet active and cannot receive donations.");
                        return;
                    }

                    const donationAmount = 10; // Simulating a $10 donation for simplicity
                    const newRaisedAmount = (campaign.raised || 0) + donationAmount;

                    try {
                        // Update the campaign's raised amount
                        const campaignDocRef = doc(db, `artifacts/${appId}/public/data/campaigns`, campaign.id);
                        await updateDoc(campaignDocRef, {
                            raised: newRaisedAmount,
                            updatedAt: new Date().toISOString()
                        });

                        // Add a detailed donation record to the campaign's subcollection
                        const campaignDonationsRef = collection(db, `artifacts/${appId}/public/data/campaigns`, campaign.id, 'donations');
                        await addDoc(campaignDonationsRef, {
                            userId: auth.currentUser.uid, // Use current user's UID (anonymous or authenticated)
                            userName: auth.currentUser.isAnonymous ? "Anonymous Donor" : (currentUser.email.split('@')[0] || "Logged In User"),
                            amount: donationAmount,
                            timestamp: new Date().toISOString(),
                            campaignTitle: campaign.title,
                            campaignCreator: campaign.creatorName
                        });

                        setCampaign(prev => ({ ...prev, raised: newRaisedAmount })); // Optimistically update UI
                        showMessage(`Thank you for donating $${donationAmount} to "${campaign.title}"!`);
                    } catch (error) {
                        console.error("Error supporting campaign:", error);
                        showMessage(`Failed to process donation: ${error.message}. Please try again.`);
                    }
                };


            if (loading) {
                return (
                    <div className="screenContainer" style={{ textAlign: 'center', paddingTop: '50px' }}>
                        <p className="heading">Loading Campaign Details...</p>
                        <p className="subHeading" style={{ color: '#FFD700' }}>Please ensure you have an internet connection.</p>
                    </div>
                );
            }

            if (!campaign) {
                return null;
            }

            const progressPercentage = (campaign.raised / campaign.goal) * 100;
            const isCampaignEnded = new Date(campaign.endDate) < new Date();
            const daysRemaining = Math.ceil((new Date(campaign.endDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));
            const isCampaignActive = campaign.status === 'active' && !isCampaignEnded;


            return (
                <div className="screenContainer">
                    <div className="campaignDetailHeader">
                        <img
                            ref={campaignImageRef}
                            src={campaign.imageUrl}
                            alt={campaign.title}
                            className="campaignDetailImage"
                            onError={(e) => { e.target.style.display = 'none'; }} /* Hide image if it fails to load */
                            style={{ display: campaign.imageUrl ? 'block' : 'none' }} /* Initially hide if no imageUrl */
                        />
                        <p className="campaignDetailTitle">
                            {campaign.title}
                            {isCampaignEnded && <span style={{color: '#DC3545', fontSize: '16px', marginLeft: '10px'}}>(Ended)</span>}
                            {!isCampaignEnded && campaign.status === 'pending' && <span style={{color: '#FFD700', fontSize: '16px', marginLeft: '10px'}}>(Pending Review)</span>}
                            {!isCampaignEnded && campaign.status === 'rejected' && <span style={{color: '#DC3545', fontSize: '16px', marginLeft: '10px'}}>(Rejected)</span>}
                            {!isCampaignEnded && campaign.status === 'active' && <span style={{color: '#00FF00', fontSize: '16px', marginLeft: '10px'}}>(Active)</span>}
                            {!isCampaignEnded && campaign.status === 'cancelled' && <span style={{color: '#888', fontSize: '16px', marginLeft: '10px'}}>(Cancelled)</span>}
                        </p>
                        <div className="campaignDetailCreator">
                            <img
                                src={campaign.creatorProfilePictureUrl || 'https://placehold.co/100x100/555/FFF?text=Profile'}
                                alt={campaign.creatorName}
                                className="campaignDetailCreatorProfilePic"
                                onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/32x32/555/FFF?text=P'; }}
                            />
                            <span>by {campaign.creatorName}</span>
                        </div>
                    </div>

                    <p className="campaignDetailDescription">{campaign.description}</p>

                    <div className="campaignDetailStats">
                        <div className="campaignDetailStatItem">
                            <p className="campaignDetailStatValue">${campaign.raised}</p>
                            <p>Raised</p>
                        </div>
                        <div className="campaignDetailStatItem">
                            <p className="campaignDetailStatValue">${campaign.goal}</p>
                            <p>Goal</p>
                        </div>
                        <div className="campaignDetailStatItem">
                            <p className="campaignDetailStatValue">{Math.round(progressPercentage)}%</p>
                            <p>Progress</p>
                        </div>
                    </div>
                    <div className="campaignDetailProgressBarContainer">
                        <div className="campaignDetailProgressBar" style={{ width: `${progressPercentage}%` }}></div>
                    </div>

                    {isCampaignEnded ? (
                        <p className="smallText" style={{ textAlign: 'center', color: '#DC3545', marginTop: '10px' }}>
                            This campaign ended on {new Date(campaign.endDate).toLocaleDateString()}.
                        </p>
                    ) : (
                        <p className="smallText" style={{ textAlign: 'center', color: '#00FF00', marginTop: '10px' }}>
                            {daysRemaining > 0 ? `${daysRemaining} days remaining` : 'Campaign ending soon!'}
                        </p>
                    )}


                    <button
                        className="button"
                        onClick={handleSupportCampaign}
                        disabled={!isCampaignActive} // Only active campaigns can be supported
                        style={!isCampaignActive ? { backgroundColor: '#555', cursor: 'not-allowed' } : {}}
                    >
                        <span className="buttonText">{isCampaignEnded ? 'Campaign Ended' : (campaign.status === 'pending' ? 'Pending Review' : (campaign.status === 'rejected' ? 'Campaign Rejected' : (campaign.status === 'cancelled' ? 'Campaign Cancelled' : 'Support This Campaign')))}</span>
                    </button>

                    {campaign.imageUrl && (
                        <button
                            className="button"
                            onClick={() => window.open(campaign.imageUrl, '_blank')}
                            style={{ backgroundColor: '#3A3A3A', color: '#FFF', marginTop: '10px' }}
                        >
                            <span className="buttonText">Visit Project Link</span>
                        </button>
                    )}

                    <button
                        className="button"
                        onClick={() => setActiveScreen('AllCampaigns')}
                        style={{ backgroundColor: '#3A3A3A', color: '#FFF', marginTop: '30px' }}
                    >
                        <span className="buttonText">Back to All Campaigns</span>
                    </button>
                </div>
            );
        };

// AdminDashboardScreen Component
const AdminDashboardScreen = ({
    showMessage,
    setActiveScreen,
    currentUser,
    setSelectedAdminCampaignId,
    creatorProfile,
    selectedAdminSubScreen,
    setSelectedAdminSubScreen,
    setShowConfirmationModal,
    setConfirmationTitle,
    setConfirmationMessage,
    setOnConfirmationAction
}) => {
    const [isUserManagementExpanded, setIsUserManagementExpanded] = useState(true);
    const [isPendingCampaignsExpanded, setIsPendingCampaignsExpanded] = useState(true);
    const [isActiveCampaignsExpanded, setIsActiveCampaignsExpanded] = useState(true);

    const [searchTerm, setSearchTerm] = useState('');
    const [selectedRole, setSelectedRole] = useState('All');

    const [pendingCampaigns, setPendingCampaigns] = useState([]);
    const [activeCampaigns, setActiveCampaigns] = useState([]);
    const [allUsers, setAllUsers] = useState([]);
    const [loading, setLoading] = useState(true);
    const [isUpdatingRole, setIsUpdatingRole] = useState(null);

    // --- START OF FIX: Confirmation Modal Logic ---
    // This function contains the core logic for changing a user's role.
    const changeUserRoleLogic = async (targetUser, newRole) => {
        setIsUpdatingRole(targetUser.id);
        showMessage(`Updating role for ${targetUser.creatorName || targetUser.email}...`);

        try {
            // NOTE: This client-side approach to changing roles is insecure.
            // In a production app, this should be handled by a Cloud Function invoked by an authorized admin.
            // For this project, we directly update Firestore.
            const userDocRef = doc(db, "creators", targetUser.id);
            await updateDoc(userDocRef, {
                role: newRole
            });

            showMessage(`Success! ${targetUser.creatorName || targetUser.email} is now a(n) ${newRole}.`);
        } catch (error) {
            console.error("Error changing user role:", error);
            showMessage(`Error: ${error.message}`);
        } finally {
            setIsUpdatingRole(null);
        }
    };
    
    // This function triggers the confirmation modal for role changes.
    const confirmChangeUserRole = (targetUser, newRole) => {
        setConfirmationTitle("Change User Role?");
        setConfirmationMessage(`Are you sure you want to change ${targetUser.creatorName || targetUser.email}'s role to "${newRole}"?`);
        // The onConfirm action now calls the logic function.
        setOnConfirmationAction(() => () => changeUserRoleLogic(targetUser, newRole));
        setShowConfirmationModal(true);
    };

    // This function contains the core logic for toggling a ban.
    const toggleBanLogic = async (userToBan) => {
        if (creatorProfile.role === 'authority' && userToBan.role === 'admin') {
            showMessage("Authority users cannot ban Admin accounts.");
            return;
        }
        if (userToBan.id === currentUser.uid) {
            showMessage("You cannot ban or unban your own account.");
            return;
        }
        try {
            const userDocRef = doc(db, "creators", userToBan.id);
            await updateDoc(userDocRef, { banned: !userToBan.banned, updatedAt: new Date().toISOString() });
            showMessage(`${userToBan.banned ? 'Unbanned' : 'Banned'} user: ${userToBan.creatorName || userToBan.email}`);
        } catch (error) {
            console.error("Error toggling ban status:", error);
            showMessage(`Failed to toggle ban status: ${error.message}`);
        }
    };

    // This function triggers the confirmation modal for banning/unbanning.
    const confirmToggleBan = (userToBan) => {
        const action = userToBan.banned ? 'Unban' : 'Ban';
        setConfirmationTitle(`${action} User?`);
        setConfirmationMessage(`Are you sure you want to ${action.toLowerCase()} user ${userToBan.creatorName || userToBan.email}?`);
        setOnConfirmationAction(() => () => toggleBanLogic(userToBan));
        setShowConfirmationModal(true);
    };
    // --- END OF FIX ---


    const toggleSection = (setterFunction, currentState) => {
        setterFunction(!currentState);
    };

    useEffect(() => {
        const campaignsCollectionRef = collection(db, `artifacts/${appId}/public/data/campaigns`);

        const qPending = query(campaignsCollectionRef, where('status', '==', 'pending'), orderBy('createdAt', 'asc'));
        const unsubscribePending = onSnapshot(qPending, (snapshot) => {
            setPendingCampaigns(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });

        const qActive = query(campaignsCollectionRef, where('status', '==', 'active'), orderBy('createdAt', 'desc'));
        const unsubscribeActive = onSnapshot(qActive, (snapshot) => {
            setActiveCampaigns(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });

        const usersCollectionRef = collection(db, "creators");
        const unsubscribeUsers = onSnapshot(usersCollectionRef, (snapshot) => {
            setAllUsers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            setLoading(false);
        });

        return () => {
            unsubscribePending();
            unsubscribeActive();
            unsubscribeUsers();
        };
    }, []);

    if (!currentUser || !creatorProfile || (creatorProfile.role !== 'admin' && creatorProfile.role !== 'authority')) {
        return (
            <div className="screenContainer">
                <p className="heading">Access Denied</p>
                <p className="subHeading">You must be an Admin or Authority to view this dashboard.</p>
                <button className="button" onClick={() => setActiveScreen('Login')}><span className="buttonText">Go to Login</span></button>
            </div>
        );
    }

    if (loading) {
        return (
            <div className="screenContainer" style={{ textAlign: 'center', paddingTop: '50px' }}>
                <p className="heading">Loading Admin Dashboard...</p>
                <p className="subHeading" style={{ color: '#FFD700' }}>Please wait.</p>
            </div>
        );
    }

    const filteredUsers = allUsers.filter(user => {
        if (creatorProfile.role === 'authority' && user.role === 'admin') {
            return false;
        }
        const matchesSearchTerm = searchTerm === '' || (user.creatorName && user.creatorName.toLowerCase().includes(searchTerm.toLowerCase())) || (user.email && user.email.toLowerCase().includes(searchTerm.toLowerCase()));
        const matchesRole = selectedRole === 'All' || user.role === selectedRole;
        return matchesSearchTerm && matchesRole;
    });

    return (
        <div className="screenContainer">
            <p className="heading">Admin Dashboard</p>
            <p className="subHeading">Manage users and crowdfunding campaigns.</p>

            <div style={{ display: 'flex', justifyContent: 'center', gap: '15px', marginBottom: '20px' }}>
                <button className="button" onClick={() => setSelectedAdminSubScreen('Overview')} style={{ backgroundColor: selectedAdminSubScreen === 'Overview' ? '#FFD700' : '#3A3A3A', color: selectedAdminSubScreen === 'Overview' ? '#0A0A0A' : '#FFF', padding: '10px 20px', borderRadius: '25px' }}>
                    <span className="buttonText">Dashboard Overview</span>
                </button>
                <button className="button" onClick={() => setSelectedAdminSubScreen('ContentManagement')} style={{ backgroundColor: selectedAdminSubScreen === 'ContentManagement' ? '#FFD700' : '#3A3A3A', color: selectedAdminSubScreen === 'ContentManagement' ? '#0A0A0A' : '#FFF', padding: '10px 20px', borderRadius: '25px' }}>
                    <span className="buttonText">Manage Content</span>
                </button>
            </div>

            {selectedAdminSubScreen === 'Overview' && (
                <>
                    <section className="dashboardSection">
                        <div className="flex justify-between items-center cursor-pointer py-2" onClick={() => toggleSection(setIsUserManagementExpanded, isUserManagementExpanded)}>
                            <p className="dashboardSectionTitle" style={{ marginBottom: '0' }}>User Management</p>
                            <button className="admin-toggle-button">{isUserManagementExpanded ? '\u25BC' : '\u25B6'}</button>
                        </div>
                        <div id="user-management-content" className={`overflow-hidden transition-max-height duration-500 ease-in-out ${isUserManagementExpanded ? 'max-h-screen' : 'max-h-0'}`}>
                            <div className="pt-4 border-t border-gray-200 mt-4" style={{ borderColor: '#3A3A3A' }}>
                                <div className="formGroup" style={{ marginBottom: '15px' }}><label htmlFor="userSearch" className="formLabel">Search Users:</label><input type="text" id="userSearch" className="formInput" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Search by name or email" /></div>
                                <div className="formGroup" style={{ marginBottom: '15px' }}><label htmlFor="roleFilter" className="formLabel">Filter by Role:</label><select id="roleFilter" className="formInput" value={selectedRole} onChange={(e) => setSelectedRole(e.target.value)}><option value="All">All Roles</option><option value="user">User</option><option value="creator">Creator</option><option value="admin">Admin</option><option value="authority">Authority</option></select></div>
                                {filteredUsers.length === 0 ? <p className="dashboardItem">No users to display matching your criteria.</p> :
                                    <div className="dashboardContentList">
                                        {filteredUsers.map(user => (
                                            <div key={user.id} className="adminDashboardItem" style={{alignItems: 'flex-start'}}>
                                                <div style={{ flexGrow: 1, marginRight: '10px' }}>
                                                    <p className="adminDashboardItemTitle">{user.creatorName || user.email}</p>
                                                    <p style={{ fontSize: '12px', color: '#CCC' }}>Role: {user.role}</p>
                                                    <p style={{ fontSize: '12px', color: user.banned ? '#DC3545' : '#00FF00' }}>Status: {user.banned ? 'Banned' : 'Active'}</p>
                                                    <p style={{ fontSize: '10px', color: '#AAA' }}>User ID: {user.id}</p>
                                                </div>
                                                <div style={{display: 'flex', flexDirection: 'column', gap: '10px', alignItems: 'flex-end'}}>
                                                    {/* --- FIX: Call confirmation function --- */}
                                                    {currentUser.uid !== user.id && <button className={`adminActionButton ${user.banned ? 'approve' : 'reject'}`} onClick={() => confirmToggleBan(user)}>{user.banned ? 'Unban' : 'Ban'}</button>}
                                                    <div className="formGroup" style={{marginBottom: 0}}>
                                                        <select
                                                            className="formInput"
                                                            value={user.role}
                                                            // --- FIX: Call confirmation function ---
                                                            onChange={(e) => confirmChangeUserRole(user, e.target.value)}
                                                            disabled={isUpdatingRole === user.id || user.id === currentUser.uid || (creatorProfile.role === 'authority' && user.role === 'admin')}
                                                            style={{padding: '5px', fontSize: '12px', width: '120px'}}
                                                        >
                                                            <option value="user">User</option>
                                                            <option value="creator">Creator</option>
                                                            <option value="authority">Authority</option>
                                                            {creatorProfile.role === 'admin' && <option value="admin">Admin</option>}
                                                        </select>
                                                        {isUpdatingRole === user.id && <p style={{fontSize: '10px', color: '#FFD700', textAlign: 'right'}}>Updating...</p>}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                }
                            </div>
                        </div>
                    </section>
                    
                    <section className="dashboardSection">
                        <div className="flex justify-between items-center cursor-pointer py-2" onClick={() => toggleSection(setIsPendingCampaignsExpanded, isPendingCampaignsExpanded)}>
                            <p className="dashboardSectionTitle" style={{ marginBottom: '0' }}>Pending Campaigns ({pendingCampaigns.length})</p>
                            <button className="admin-toggle-button">{isPendingCampaignsExpanded ? '\u25BC' : '\u25B6'}</button>
                        </div>
                        <div id="pending-campaigns-content" className={`overflow-hidden transition-max-height duration-500 ease-in-out ${isPendingCampaignsExpanded ? 'max-h-screen' : 'max-h-0'}`}>
                            <div className="pt-4 border-t border-gray-200 mt-4" style={{ borderColor: '#3A3A3A' }}>
                                {pendingCampaigns.length === 0 ? <p className="dashboardItem">No campaigns currently pending review.</p> :
                                    <div className="dashboardContentList">
                                        {pendingCampaigns.map(campaign => (
                                            <div key={campaign.id} className="adminDashboardItem" onClick={() => { setSelectedAdminCampaignId(campaign.id); setActiveScreen('AdminCampaignDetails'); }}>
                                                <div style={{ flexGrow: 1, marginRight: '10px' }}>
                                                    <p className="adminDashboardItemTitle">{campaign.title}</p>
                                                    <p style={{ fontSize: '12px', color: '#CCC' }}>by {campaign.creatorName}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                }
                            </div>
                        </div>
                    </section>

                    <section className="dashboardSection">
                        <div className="flex justify-between items-center cursor-pointer py-2" onClick={() => toggleSection(setIsActiveCampaignsExpanded, isActiveCampaignsExpanded)}>
                            <p className="dashboardSectionTitle" style={{ marginBottom: '0' }}>Active Campaigns ({activeCampaigns.length})</p>
                            <button className="admin-toggle-button">{isActiveCampaignsExpanded ? '\u25BC' : '\u25B6'}</button>
                        </div>
                        <div id="active-campaigns-content" className={`overflow-hidden transition-max-height duration-500 ease-in-out ${isActiveCampaignsExpanded ? 'max-h-screen' : 'max-h-0'}`}>
                            <div className="pt-4 border-t border-gray-200 mt-4" style={{ borderColor: '#3A3A3A' }}>
                                {activeCampaigns.length === 0 ? <p className="dashboardItem">No campaigns currently active.</p> :
                                    <div className="dashboardContentList">
                                        {activeCampaigns.map(campaign => (
                                            <div key={campaign.id} className="adminDashboardItem" onClick={() => { setSelectedAdminCampaignId(campaign.id); setActiveScreen('AdminCampaignDetails'); }}>
                                                <div style={{ flexGrow: 1, marginRight: '10px' }}>
                                                    <p className="adminDashboardItemTitle">{campaign.title}</p>
                                                    <p style={{ fontSize: '12px', color: '#CCC' }}>by {campaign.creatorName}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                }
                            </div>
                        </div>
                    </section>

                    <button className="button" onClick={() => setActiveScreen('Home')} style={{ backgroundColor: '#3A3A3A', color: '#FFF', marginTop: '30px' }}><span className="buttonText">Back to Home</span></button>
                </>
            )}

            {selectedAdminSubScreen === 'ContentManagement' && (
                <AdminContentManagerScreen
                    showMessage={showMessage}
                    setActiveScreen={setActiveScreen}
                    currentUser={currentUser}
                    creatorProfile={creatorProfile}
                    // --- Pass the modal props down ---
                    setShowConfirmationModal={setShowConfirmationModal}
                    setConfirmationTitle={setConfirmationTitle}
                    setConfirmationMessage={setConfirmationMessage}
                    setOnConfirmationAction={setOnConfirmationAction}
                />
            )}
        </div>
    );
};


        const ConfirmationModal = ({ title, message, onConfirm, onCancel }) => {
            return (
                <div className="confirmationModalOverlay">
                    <div className="confirmationModalContent">
                        <p className="confirmationModalTitle">{title}</p>
                        <p className="confirmationModalMessage">{message}</p>
                        <div className="confirmationModalButtons">
                            <button className="confirmationButton confirm" onClick={() => {
                                if (typeof onConfirm === 'function') {
                                    onConfirm(); // First, run the assigned action
                                }
                                onCancel();  // Then, run the function that closes the modal
                            }}>Confirm</button>
                            <button className="confirmationButton cancel" onClick={onCancel}>Cancel</button>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminCampaignDetailsScreen = ({ showMessage, setActiveScreen, currentUser, selectedAdminCampaignId, setShowConfirmationModal, setConfirmationTitle, setConfirmationMessage, setOnConfirmationAction, creatorProfile }) => {
            const [campaign, setCampaign] = useState(null);
            const [loading, setLoading] = useState(true);
            const campaignImageRef = useRef(null);

            useEffect(() => {
                const fetchCampaignDetails = async () => {
                    if (!selectedAdminCampaignId) {
                        showMessage("No campaign selected for review.");
                        setActiveScreen('AdminDashboard');
                        return;
                    }

                    try {
                        const campaignDocRef = doc(db, `artifacts/${appId}/public/data/campaigns`, selectedAdminCampaignId);
                        const docSnap = await getDoc(campaignDocRef);

                        if (docSnap.exists()) {
                            setCampaign({ id: docSnap.id, ...docSnap.data() });
                        } else {
                            showMessage("Campaign not found.");
                            setActiveScreen('AdminDashboard');
                        }
                        setLoading(false);
                    } catch (error) {
                        console.error("Error fetching campaign details for admin review:", error);
                        showMessage("Failed to load campaign details for review. Please try again.");
                        setLoading(false);
                        setActiveScreen('AdminDashboard');
                    }
                };

                fetchCampaignDetails();
            }, [selectedAdminCampaignId, setActiveScreen, showMessage]);

            const confirmApprove = () => {
                // Check if current user is an authority and the campaign creator is an admin
                if (creatorProfile.role === 'authority' && campaign && campaign.creatorId) {
                    // Fetch the creator's role to check if they are an "admin"
                    // This is done via a separate getDoc call to respect Firestore rules that might prevent direct read of creator.role from request.resource
                    const creatorDocRef = doc(db, "creators", campaign.creatorId);
                    getDoc(creatorDocRef).then(docSnap => {
                        if (docSnap.exists() && docSnap.data().role === 'admin') {
                            showMessage("Authority users cannot approve campaigns created by Admin accounts.");
                            return;
                        } else {
                            setShowConfirmationModal(true);
                            setConfirmationTitle("Approve Campaign?");
                            setConfirmationMessage(`Are you sure you want to APPROVE campaign "${campaign.title}"?`);
                            setOnConfirmationAction(() => handleApproveCampaign);
                        }
                    }).catch(error => {
                        console.error("Error fetching creator role:", error);
                        showMessage("Could not verify campaign creator's role. Please try again.");
                    });
                } else {
                    setShowConfirmationModal(true);
                    setConfirmationTitle("Approve Campaign?");
                    setConfirmationMessage(`Are you sure you want to APPROVE campaign "${campaign.title}"?`);
                            setOnConfirmationAction(() => handleApproveCampaign);
                }
            };

            const handleApproveCampaign = async () => {
                setShowConfirmationModal(false); // Close modal
                if (!campaign || !currentUser) return;

                try {
                    const campaignDocRef = doc(db, `artifacts/${appId}/public/data/campaigns`, campaign.id);
                    await updateDoc(campaignDocRef, {
                        status: 'active',
                        approvedBy: currentUser.uid,
                        approvedAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                    showMessage(`Campaign "${campaign.title}" approved successfully!`);
                    setActiveScreen('AdminDashboard'); // Go back to dashboard
                } catch (error) {
                    console.error("Error approving campaign:", error);
                    showMessage(`Failed to approve campaign: ${error.message}`);
                }
            };

            const confirmReject = () => {
                // Check if current user is an authority and the campaign creator is an admin
                if (creatorProfile.role === 'authority' && campaign && campaign.creatorId) {
                    const creatorDocRef = doc(db, "creators", campaign.creatorId);
                    getDoc(creatorDocRef).then(docSnap => {
                        if (docSnap.exists() && docSnap.data().role === 'admin') {
                            showMessage("Authority users cannot reject campaigns created by Admin accounts.");
                            return;
                        } else {
                            setShowConfirmationModal(true);
                            setConfirmationTitle("Reject Campaign?");
                            setConfirmationMessage(`Are you sure you want to REJECT campaign "${campaign.title}"?`);
                            setOnConfirmationAction(() => handleRejectCampaign);
                        }
                    }).catch(error => {
                        console.error("Error fetching creator role:", error);
                        showMessage("Could not verify campaign creator's role. Please try again.");
                    });
                } else {
                    setShowConfirmationModal(true);
                    setConfirmationTitle("Reject Campaign?");
                    setConfirmationMessage(`Are you sure you want to REJECT campaign "${campaign.title}"?`);
                    setOnConfirmationAction(() => handleRejectCampaign);
                }
            };

            const handleRejectCampaign = async () => {
                setShowConfirmationModal(false); // Close modal
                if (!campaign || !currentUser) return;

                try {
                    const campaignDocRef = doc(db, `artifacts/${appId}/public/data/campaigns`, campaign.id);
                    await updateDoc(campaignDocRef, {
                        status: 'rejected',
                        rejectedBy: currentUser.uid,
                        rejectedAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                    showMessage(`Campaign "${campaign.title}" rejected.`);
                    setActiveScreen('AdminDashboard'); // Go back to dashboard
                } catch (error) {
                    console.error("Error rejecting campaign:", error);
                    showMessage(`Failed to reject campaign: ${error.message}`);
                }
            };

            const confirmEndCampaignByAdmin = () => {
                // Check if current user is an authority and the campaign creator is an admin
                if (creatorProfile.role === 'authority' && campaign && campaign.creatorId) {
                    const creatorDocRef = doc(db, "creators", campaign.creatorId);
                    getDoc(creatorDocRef).then(docSnap => {
                        if (docSnap.exists() && docSnap.data().role === 'admin') {
                            showMessage("Authority users cannot end campaigns created by Admin accounts.");
                            return;
                        } else {
                            setShowConfirmationModal(true);
                            setConfirmationTitle("End Campaign?");
                            setConfirmationMessage(`Are you sure you want to manually END campaign "${campaign.title}"? This will set its status to 'ended'.`);
                            setOnConfirmationAction(() => handleEndCampaignByAdmin);
                        }
                    }).catch(error => {
                        console.error("Error fetching creator role:", error);
                        showMessage("Could not verify campaign creator's role. Please try again.");
                    });
                } else {
                    setShowConfirmationModal(true);
                    setConfirmationTitle("End Campaign?");
                    setConfirmationMessage(`Are you sure you want to manually END campaign "${campaign.title}"? This will set its status to 'ended'.`);
                    setOnConfirmationAction(() => handleEndCampaignByAdmin);
                }
            };

            const handleEndCampaignByAdmin = async () => {
                setShowConfirmationModal(false); // Close modal
                if (!campaign || !currentUser) return;

                try {
                    const campaignDocRef = doc(db, `artifacts/${appId}/public/data/campaigns`, campaign.id);
                    await updateDoc(campaignDocRef, {
                        status: 'ended', // Set status to 'ended'
                        endedByAdmin: currentUser.uid, // Track admin who ended it
                        endedAt: new Date().toISOString(), // Use the current time as endedAt
                        updatedAt: new Date().toISOString()
                    });
                    showMessage(`Campaign "${campaign.title}" has been manually ended by admin.`);
                    setActiveScreen('AdminDashboard'); // Go back to dashboard after action
                } catch (error) {
                    console.error("Error ending campaign by admin:", error);
                    showMessage(`Failed to end campaign: ${error.message}`);
                }
            };

            if (loading) {
                return (
                    <div className="screenContainer" style={{ textAlign: 'center', paddingTop: '50px' }}>
                        <p className="heading">Loading Campaign Details for Review...</p>
                        <p className="subHeading" style={{ color: '#FFD700' }}>Please wait.</p>
                    </div>
                );
            }

            if (!campaign) {
                return null; // Should not happen if loading is false and campaignId is present
            }

            const createdDate = campaign.createdAt ? new Date(campaign.createdAt).toLocaleDateString() : 'N/A';
            const endDate = campaign.endDate ? new Date(campaign.endDate).toLocaleDateString() : 'N/A';

            return (
                <div className="screenContainer">
                    <p className="heading">Review Campaign</p>
                    <p className="subHeading">{campaign.title}</p>

                    <div className="dashboardSection">
                        <p className="dashboardSectionTitle">Campaign Details</p>
                        <div style={{ display: 'flex', alignItems: 'center', marginBottom: '15px' }}>
                            <img
                                src={campaign.creatorProfilePictureUrl || 'https://placehold.co/100x100/555/FFF?text=Profile'}
                                alt={campaign.creatorName}
                                style={{ width: '60px', height: '60px', borderRadius: '50%', objectFit: 'cover', marginRight: '15px', border: '2px solid #FFD700' }}
                                onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/60x60/555/FFF?text=P'; }}
                            />
                            <div>
                                <p className="dashboardItem" style={{ marginBottom: '0' }}>**Creator:** {campaign.creatorName}</p>
                                <p className="dashboardItem" style={{ fontSize: '12px', color: '#AAA' }}>Creator ID: {campaign.creatorId}</p>
                            </div>
                        </div>

                        <p className="dashboardItem">**Description:** {campaign.description}</p>
                        <p className="dashboardItem">**Funding Goal:** ${campaign.goal}</p>
                        <p className="dashboardItem">**Current Raised:** ${campaign.raised}</p>
                        <p className="dashboardItem">**Status:** <span style={{ color: campaign.status === 'pending' ? '#FFD700' : (campaign.status === 'active' ? '#00FF00' : (campaign.status === 'cancelled' ? '#888' : '#DC3545')) }}>{campaign.status}</span></p>
                        <p className="dashboardItem">**Created On:** {createdDate}</p>
                        <p className="dashboardItem">**Ends On:** {endDate}</p>

                        {campaign.imageUrl && (
                            <div style={{ marginTop: '15px' }}>
                                <p className="formLabel">Project Image/Link:</p>
                                <img
                                    ref={campaignImageRef}
                                    src={campaign.imageUrl}
                                    alt="Campaign Project"
                                    style={{ width: '100%', maxWidth: '300px', height: 'auto', borderRadius: '8px', objectFit: 'contain', marginTop: '10px' }}
                                    onError={(e) => { e.target.style.display = 'none'; showMessage('Project image failed to load.'); }}
                                />
                                <button
                                    className="button"
                                    onClick={() => window.open(campaign.imageUrl, '_blank')}
                                    style={{ backgroundColor: '#3A3A3A', color: '#FFF', marginTop: '10px', width: 'auto', alignSelf: 'flex-start', padding: '8px 15px', fontSize: '14px' }}
                                >
                                    <span className="buttonText">Open Project Link in New Tab</span>
                                </button>
                            </div>
                        )}
                    </div>

                    <div style={{ display: 'flex', justifyContent: 'space-around', marginTop: '20px' }}>
                        {campaign.status === 'pending' && ( // Only show approve/reject for pending
                            <>
                                <button
                                    className="adminActionButton approve"
                                    onClick={confirmApprove}
                                >
                                    Approve Campaign
                                </button>
                                <button
                                    className="adminActionButton reject"
                                    onClick={confirmReject}
                                >
                                    Reject Campaign
                                </button>
                            </>
                        )}
                        {campaign.status === 'active' && ( // Show End button only for active campaigns
                            <button
                                className="adminActionButton"
                                onClick={confirmEndCampaignByAdmin}
                                style={{ backgroundColor: '#FF8C00' }} // Orange color for 'End Campaign'
                            >
                                End Campaign
                            </button>
                        )}
                    </div>

                    <button
                        className="button"
                        onClick={() => setActiveScreen('AdminDashboard')}
                        style={{ backgroundColor: '#3A3A3A', color: '#FFF', marginTop: '30px' }}
                    >
                        <span className="buttonText">Back to Admin Dashboard</span>
                    </button>
                </div>
            );
        };

        // Helper function for extracting video IDs and creating embed/thumbnail URLs
                // Helper function for extracting video IDs and creating embed/thumbnail URLs
        const extractVideoInfo = (url) => {
            let videoId = null;
            let thumbnailUrl = '';
            let embedUrl = '';
            let platform = 'generic';
            let isVertical = false; // Flag for vertical videos like Shorts or TikToks

            // YouTube (Now includes /shorts/)
            let match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|shorts\/))([^&?#]+)/);
            if (match && match[1]) {
                videoId = match[1];
                thumbnailUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
                platform = 'youtube';
                if (url.includes('/shorts/')) {
                    isVertical = true;
                }
            } else {
                // Facebook
                match = url.match(/(?:facebook\.com\/(?:video.php\?v=|watch\/\?v=)|fb\.watch\/|facebook\.com\/[^\/]+\/videos\/)([0-9]+)/);
                if (match && match[1]) {
                    videoId = match[1];
                    thumbnailUrl = `https://placehold.co/150x100/4267B2/FFFFFF?text=Facebook`;
                    embedUrl = `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(url)}&show_text=0&width=560&autoplay=1`;
                    platform = 'facebook';
                } else {
                    // TikTok
                    match = url.match(/(?:tiktok\.com\/@(?:[a-zA-Z0-9._]+)\/video\/|vm\.tiktok\.com\/|tiktok\.com\/embed\/)([0-9]+)/);
                    if (match && match[1]) {
                        videoId = match[1];
                        isVertical = true; // TikTok videos are vertical
                        thumbnailUrl = `https://placehold.co/150x100/69C9D0/FFFFFF?text=TikTok`;
                        embedUrl = `https://www.tiktok.com/embed/${videoId}`;
                        platform = 'tiktok';
                    }
                }
            }

            return { videoId, thumbnailUrl, embedUrl, platform, isVertical };
        };


const AdminContentManagerScreen = ({
    showMessage,
    setActiveScreen,
    currentUser,
    creatorProfile,
    setShowConfirmationModal,
    setConfirmationTitle,
    setConfirmationMessage,
    setOnConfirmationAction
}) => {
    const [contentItems, setContentItems] = useState([]);
    const [loading, setLoading] = useState(true);

    const [title, setTitle] = useState('');
    const [mainUrl, setMainUrl] = useState('');
    const [customThumbnailFile, setCustomThumbnailFile] = useState(null);
    const [customThumbnailUrlPreview, setCustomThumbnailUrlPreview] = useState('');
    // --- FIX: Added state for the auto-fetched thumbnail ---
    const [autoThumbnailPreview, setAutoThumbnailPreview] = useState('');
    const [creatorName, setCreatorName] = useState('');
    const [contentType, setContentType] = useState('Skits');
    const [orderIndex, setOrderIndex] = useState(0);
    const [isActive, setIsActive] = useState(true);
    const [description, setDescription] = useState('');

    const thumbnailFileInputRef = useRef(null);
    const availableContentCategories = ['Trending', 'Featured', 'Live Feed', 'Skits', 'Short Films', 'Interviews', 'Live Premieres', 'Music', 'Documentary', 'Other'];

    useEffect(() => {
        if (creatorProfile) {
            if (creatorProfile.role === 'authority') {
                setCreatorName(creatorProfile.creatorName || currentUser.email);
            } else {
                setCreatorName('');
            }
        }
    }, [creatorProfile]);

    // --- FIX: Added useEffect to fetch thumbnail from mainUrl ---
    useEffect(() => {
        if (!mainUrl) {
            setAutoThumbnailPreview('');
            return;
        }
        const handler = setTimeout(() => {
            const { thumbnailUrl } = extractVideoInfo(mainUrl);
            if (thumbnailUrl) {
                setAutoThumbnailPreview(thumbnailUrl);
            } else {
                setAutoThumbnailPreview('');
            }
        }, 800);

        return () => clearTimeout(handler);
    }, [mainUrl]);

    useEffect(() => {
        const contentCollectionRef = collection(db, `artifacts/${appId}/public/data/content_items`);
        const q = query(contentCollectionRef, orderBy('orderIndex', 'asc'), orderBy('createdAt', 'desc'));

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const fetchedItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setContentItems(fetchedItems);
            setLoading(false);
        }, (error) => {
            console.error("Error fetching content items for admin:", error);
            showMessage("Failed to load content items.");
            setLoading(false);
        });

        return () => unsubscribe();
    }, [showMessage]);

    const resetForm = () => {
        setTitle('');
        setMainUrl('');
        setCustomThumbnailFile(null);
        setCustomThumbnailUrlPreview('');
        // --- FIX: Reset the auto-thumbnail preview as well ---
        setAutoThumbnailPreview('');
        if (creatorProfile && creatorProfile.role === 'authority') {
            setCreatorName(creatorProfile.creatorName || '');
        } else {
            setCreatorName('');
        }
        setContentType('Skits');
        setOrderIndex(0);
        setIsActive(true);
        setDescription('');
        if (thumbnailFileInputRef.current) {
            thumbnailFileInputRef.current.value = '';
        }
    };

    const handleAddContent = async (e) => {
        e.preventDefault();
        if (!title || !mainUrl || !creatorName || !contentType) {
            showMessage('Please fill in all required fields.');
            return;
        }
        if (!currentUser || (creatorProfile.role !== 'admin' && creatorProfile.role !== 'authority')) {
            showMessage("You don't have permission to add content.");
            return;
        }
        let finalThumbnailUrl = '';
        let embedUrl = '';
        let videoPlatform = 'generic';
        const { thumbnailUrl, embedUrl: extractedEmbedUrl, platform: extractedPlatform } = extractVideoInfo(mainUrl);
        if (extractedEmbedUrl) {
            embedUrl = extractedEmbedUrl;
            videoPlatform = extractedPlatform;
            finalThumbnailUrl = thumbnailUrl;
        } else {
            finalThumbnailUrl = 'https://placehold.co/150x100/3A3A3A/FFF?text=Generic+Link';
        }
        if (customThumbnailFile) {
            showMessage('Uploading custom thumbnail...');
            try {
                const fileName = `content_thumbnails/${currentUser.uid}_${Date.now()}_${customThumbnailFile.name}`;
                const storageRefPath = ref(storage, fileName);
                await uploadBytes(storageRefPath, customThumbnailFile);
                finalThumbnailUrl = await getDownloadURL(storageRefPath);
                showMessage('Custom thumbnail uploaded successfully!');
            } catch (error) {
                console.error("Error uploading custom thumbnail:", error);
                showMessage(`Failed to upload custom thumbnail: ${error.message}`);
                return;
            }
        }
        try {
            await addDoc(collection(db, `artifacts/${appId}/public/data/content_items`), {
                title, 
                description, 
                mainUrl, 
                customThumbnailUrl: finalThumbnailUrl, 
                embedUrl, 
                videoPlatform,
                creatorId: currentUser.uid,
                creatorName, 
                contentType, 
                orderIndex: parseInt(orderIndex), 
                isActive, 
                createdAt: new Date().toISOString(), 
                createdBy: currentUser.uid, 
                createdByName: creatorProfile.creatorName || currentUser.email,
            });
            showMessage('Content item added successfully!');
            resetForm();
        } catch (error) {
            console.error("Error adding content item:", error);
            showMessage(`Failed to add content item: ${error.message}`);
        }
    };

    const deleteContentLogic = async (id, titleToDelete) => {
        if (!currentUser || (creatorProfile.role !== 'admin' && creatorProfile.role !== 'authority')) {
            showMessage("You don't have permission to delete content.");
            return;
        }
        try {
            await deleteDoc(doc(db, `artifacts/${appId}/public/data/content_items`, id));
            showMessage(`Content item "${titleToDelete}" deleted successfully.`);
        } catch (error) {
            console.error("Error deleting content item:", error);
            showMessage(`Failed to delete content item: ${error.message}`);
        }
    };
    
    const confirmDeleteContent = (id, titleToDelete) => {
        setConfirmationTitle("Delete Content?");
        setConfirmationMessage(`Are you sure you want to permanently delete "${titleToDelete}"? This action cannot be undone.`);
        setOnConfirmationAction(() => () => deleteContentLogic(id, titleToDelete));
        setShowConfirmationModal(true);
    };

    const handleToggleActive = async (item) => {
        if (!currentUser || (creatorProfile.role !== 'admin' && creatorProfile.role !== 'authority')) { showMessage("You don't have permission to modify content status."); return; }
        try {
            await updateDoc(doc(db, `artifacts/${appId}/public/data/content_items`, item.id), {
                isActive: !item.isActive, updatedAt: new Date().toISOString(), updatedBy: currentUser.uid
            });
            showMessage(`Content item "${item.title}" status changed to ${!item.isActive ? 'Active' : 'Inactive'}.`);
        } catch (error) {
            console.error("Error toggling content active status:", error);
            showMessage(`Failed to toggle content status: ${error.message}`);
        }
    };

    if (!currentUser || (creatorProfile.role !== 'admin' && creatorProfile.role !== 'authority')) {
        return (
            <div className="screenContainer">
                <p className="heading">Access Denied</p>
                <p className="subHeading">You must be an Admin or Authority to manage content.</p>
                <button className="button" onClick={() => setActiveScreen('AdminDashboard')}><span className="buttonText">Back to Admin Dashboard</span></button>
            </div>
        );
    }
    
    // --- FIX: Logic to determine which preview to show ---
    const currentPreview = customThumbnailUrlPreview || autoThumbnailPreview;

    return (
        <div className="screenContainer">
            <p className="heading">Manage Content</p>
            <p className="subHeading">Add and review content items for Featured, Live Feed, and Categories.</p>
            <div className="dashboardSection">
                <p className="dashboardSectionTitle">Add New Content Item</p>
                <form onSubmit={handleAddContent}>
                    <div className="formGroup"><label htmlFor="contentTitle" className="formLabel">Title:</label><input type="text" id="contentTitle" className="formInput" value={title} onChange={(e) => setTitle(e.target.value)} required /></div>
                    <div className="formGroup"><label htmlFor="contentDescription" className="formLabel">Description:</label><textarea id="contentDescription" className="formTextarea" value={description} onChange={(e) => setDescription(e.target.value)} placeholder="Brief description for the content item"></textarea></div>
                    <div className="formGroup"><label htmlFor="mainUrl" className="formLabel">Main Content URL (Video/Project Link):</label><input type="url" id="mainUrl" className="formInput" value={mainUrl} onChange={(e) => setMainUrl(e.target.value)} placeholder="e.g., YouTube link, Facebook video" required /><p className="smallText" style={{textAlign: 'left', marginTop: '5px', color: '#AAA'}}>We'll try to extract a thumbnail from this link.</p></div>
                    
                    {/* --- FIX: Display the thumbnail preview --- */}
                    {currentPreview && (
                        <div style={{ marginTop: '10px' }}>
                            <p className="formLabel" style={{marginBottom: '5px'}}>Thumbnail Preview:</p>
                            <img src={currentPreview} alt="Thumbnail Preview" style={{ maxWidth: '150px', borderRadius: '8px', border: '2px solid #FFD700' }} />
                        </div>
                    )}

                    <div className="formGroup"><label htmlFor="customThumbnailFile" className="formLabel">Custom Thumbnail Image (Optional):</label><input type="file" id="customThumbnailFile" ref={thumbnailFileInputRef} className="formInput" onChange={(e) => { const file = e.target.files[0]; setCustomThumbnailFile(file); if (file) { setCustomThumbnailUrlPreview(URL.createObjectURL(file)); } else { setCustomThumbnailUrlPreview(''); } }} accept="image/*" style={{padding: '10px 0', border: 'none', backgroundColor: 'transparent'}} /><p className="smallText" style={{textAlign: 'left', marginTop: '5px', color: '#AAA'}}>Upload an image to override the thumbnail from the video link.</p></div>
                    
                    <div className="formGroup">
                        <label htmlFor="creatorName" className="formLabel">Creator Name:</label>
                        <input
                            type="text"
                            id="creatorName"
                            className="formInput"
                            value={creatorName}
                            onChange={(e) => setCreatorName(e.target.value)}
                            required
                            disabled={creatorProfile && creatorProfile.role === 'authority'}
                            style={creatorProfile && creatorProfile.role === 'authority' ? { backgroundColor: '#2A2A2A', cursor: 'not-allowed' } : {}}
                        />
                    </div>

                    <div className="formGroup"><label htmlFor="contentType" className="formLabel">Content Type:</label><select id="contentType" className="formInput" value={contentType} onChange={(e) => setContentType(e.target.value)} required>{availableContentCategories.map(cat => (<option key={cat} value={cat}>{cat}</option>))}</select></div>
                    <div className="formGroup"><label htmlFor="orderIndex" className="formLabel">Display Order Index (Lower numbers appear first):</label><input type="number" id="orderIndex" className="formInput" value={orderIndex} onChange={(e) => setOrderIndex(e.target.value)} min="0" /></div>
                    <div className="formGroup"><div className="checkboxItem"><input type="checkbox" id="isActive" checked={isActive} onChange={(e) => setIsActive(e.target.checked)} /><label htmlFor="isActive">Is Active (Show on public pages)</label></div></div>
                    <button type="submit" className="button"><span className="buttonText">Add Content Item</span></button>
                    <button type="button" className="button" onClick={resetForm} style={{ backgroundColor: '#555', color: '#FFF', marginLeft: '10px' }}><span className="buttonText">Clear Form</span></button>
                </form>
            </div>

            <div className="dashboardSection" style={{ marginTop: '30px' }}>
                <p className="dashboardSectionTitle">Existing Content Items ({contentItems.length})</p>
                {loading ? <p>Loading...</p> : (
                    <div className="dashboardContentList">
                        {contentItems.map(item => (
                            <div key={item.id} className="adminDashboardItem">
                                <img src={item.customThumbnailUrl || 'https://placehold.co/50x50/3A3A3A/FFF?text=X'} alt="Thumbnail" style={{ width: '50px', height: '50px', borderRadius: '5px', objectFit: 'cover', marginRight: '10px' }} />
                                <div style={{ flexGrow: 1 }}>
                                    <p className="adminDashboardItemTitle">{item.title}</p>
                                    <p style={{ fontSize: '12px', color: '#CCC' }}>Creator: {item.creatorName} | Type: {item.contentType}</p>
                                    <p style={{ fontSize: '12px', color: item.isActive ? '#00FF00' : '#DC3545' }}>Status: {item.isActive ? 'Active' : 'Inactive'}</p>
                                </div>
                                <button className="adminActionButton" onClick={() => handleToggleActive(item)} style={{ backgroundColor: item.isActive ? '#DC3545' : '#008000', color: '#FFF' }}>{item.isActive ? 'Deactivate' : 'Activate'}</button>
                                <button className="adminActionButton reject" onClick={() => confirmDeleteContent(item.id, item.title)}>Delete</button>
                            </div>
                        ))}
                    </div>
                )}
            </div>
            <button className="button" onClick={() => setActiveScreen('AdminDashboard')} style={{ backgroundColor: '#3A3A3A', color: '#FFF', marginTop: '30px' }}><span className="buttonText">Back to Admin Dashboard</span></button>
        </div>
    );
};
// =================== END: REPLACE THIS ENTIRE COMPONENT ===================


        // New UserSignUpScreen component
        const UserSignUpScreen = ({ showMessage, setActiveScreen }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [agreedToTerms, setAgreedToTerms] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!agreedToTerms) {
                    showMessage('Please agree to the Terms & Conditions to sign up.');
                    return;
                }

                if (password.length < 8) {
                    showMessage('Password must be at least 8 characters long.');
                    return;
                }
                if (!/\d/.test(password)) {
                    showMessage('Password must include at least one number.');
                    return;
                }
                if (!/[A-Z]/.test(password)) {
                    showMessage('Password must include at least one capital letter.');
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    const creatorRef = doc(db, "creators", user.uid);
                    await setDoc(creatorRef, {
                        email: user.email,
                        creatorName: user.email.split('@')[0] || "", // Default name from email
                        bio: "",
                        categories: [],
                        existingWorkLink: "",
                        profilePictureUrl: '',
                        uploadedVideos: { youtube: null, facebook: null, tiktok: null },
                        createdAt: new Date().toISOString(),
                        role: 'user', // Explicitly set role to 'user'
                        banned: false
                    });

                    showMessage(`Account created successfully for ${email}!`);
                    setActiveScreen('CreatorDashboard'); // Redirect to the simplified dashboard
                }
                catch (error) {
                    console.error("Error signing up user:", error);
                    let errorMessage = "Failed to sign up. Please try again.";
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = "This email is already in use. Please use a different email or sign in.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Invalid email address format.";
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = "Password is too weak. Please choose a stronger password.";
                    } else if (error.code === 'auth/network-request-failed') {
                        errorMessage = "Network error. Please check your internet connection.";
                    } else if (error.code === 'auth/operation-not-allowed') {
                        errorMessage = "Email/Password sign-in is not enabled. Please enable it in Firebase Console.";
                    } else if (error.code === 'auth/missing-or-invalid-nonce') {
                        errorMessage = "Sign-up session expired or invalid. Please refresh the page and try again.";
                    }
                    showMessage(errorMessage);
                }
            };

            return (
                <div className="screenContainer">
                    <p className="heading">Create Your Account</p>
                    <p className="subHeading">Sign up to access exclusive content and support creators!</p>

                    <form onSubmit={handleSubmit}>
                        <div className="formGroup">
                            <label htmlFor="userEmail" className="formLabel">Email:</label>
                            <input
                                type="email"
                                id="userEmail"
                                className="formInput"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                required
                            />
                        </div>

                        <div className="formGroup">
                            <label htmlFor="userPassword" className="formLabel">Password:</label>
                            <input
                                type="password"
                                id="userPassword"
                                className="formInput"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                required
                            />
                            <p className="smallText" style={{ textAlign: 'left', color: '#FFD700', marginTop: '5px' }}>
                                Password must be at least 8 characters long, include at least one number and one capital letter.
                            </p>
                        </div>

                        <div className="formGroup">
                            <div className="checkboxItem">
                                <input
                                    type="checkbox"
                                    id="agreeUserTerms"
                                    checked={agreedToTerms}
                                    onChange={(e) => setAgreedToTerms(e.target.checked)}
                                    required
                                />
                                <label htmlFor="agreeUserTerms">
                                    I agree to the <a href="#" className="termsLink" onClick={(e) => { e.preventDefault(); showMessage('Simulating opening User Terms & Conditions...'); }}>Terms & Conditions</a>.
                                </label>
                            </div>
                        </div>

                        <button type="submit" className="button">
                            <span className="buttonText">Sign Up</span>
                        </button>
                    </form>

                    <p className="smallText" style={{ marginTop: '20px' }}>
                        Already have an account?{' '}
                        <a href="#" className="termsLink" onClick={(e) => { e.preventDefault(); setActiveScreen('Login'); }}>Login Here</a>
                    </p>

                    <button
                        className="button"
                        onClick={() => setActiveScreen('Home')}
                        style={{ backgroundColor: '#3A3A3A', color: '#FFF', marginTop: '30px' }}
                    >
                        <span className="buttonText">Back to Home</span>
                    </button>
                </div>
            );
        };
        
        const CategoriesScreen = ({ showMessage }) => {
            // Define the categories that will appear as tabs
            const categoryTabsList = ['Skits', 'Short Films', 'Interviews', 'Live Premieres', 'Music', 'Documentary'];
            const [activeCategory, setActiveCategory] = useState('Skits');
            const [content, setContent] = useState([]);
            const [loading, setLoading] = useState(true);

            const [showVideoModal, setShowVideoModal] = useState(false);
            const [currentVideoUrl, setCurrentVideoUrl] = useState('');

            useEffect(() => {
                setLoading(true);
                const contentCollectionRef = collection(db, `artifacts/${appId}/public/data/content_items`);
                const q = query(
                    contentCollectionRef,
                    where('contentType', '==', activeCategory),
                    where('isActive', '==', true),
                    orderBy('createdAt', 'desc')
                );

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedContent = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setContent(fetchedContent);
                    setLoading(false);
                }, (error) => {
                    console.error(`Error fetching ${activeCategory}:`, error);
                    showMessage(`Failed to load content for ${activeCategory}.`);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [activeCategory]); // Re-run this effect whenever the active category changes

            const handleVideoPress = (url) => {
                setCurrentVideoUrl(url);
                setShowVideoModal(true);
            };

            const closeVideoModal = () => {
                setShowVideoModal(false);
                setCurrentVideoUrl('');
            };

            return (
                <div className="screenContainer">
                    <p className="sectionTitle">Discover Content</p>
                    <div className="categoryTabs">
                        {categoryTabsList.map(category => (
                            <button
                                key={category}
                                className={`categoryTab ${activeCategory === category ? 'activeCategoryTab' : ''}`}
                                onClick={() => setActiveCategory(category)}
                            >
                                <span className={`categoryTabText ${activeCategory === category ? 'activeCategoryTabText' : ''}`}>
                                    {category}
                                </span>
                            </button>
                        ))}
                    </div>
                    <div className="categoryContent">
                        {loading ? (
                            <p style={{textAlign: 'center', marginTop: '20px'}}>Loading {activeCategory}...</p>
                        ) : content.length === 0 ? (
                            <p style={{textAlign: 'center', marginTop: '20px'}}>No content found in this category yet.</p>
                        ) : (
                            <div className="contentGrid">
                                {content.map(item => (
                                    <div key={item.id} className="contentCard" onClick={() => handleVideoPress(item.embedUrl || item.mainUrl)}>
                                        <div className="thumbnailPlaceholder" style={{backgroundImage: `url(${item.customThumbnailUrl})`, backgroundSize: 'cover', backgroundPosition: 'center'}}>
                                            <svg className="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                        </div>
                                        <p className="contentTitle">{item.title}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    {showVideoModal && (
                        <VideoPlayerModal videoUrl={currentVideoUrl} onClose={closeVideoModal} />
                    )}
                </div>
            );
        };


        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [activeScreen, setActiveScreen] = useState('Home');

            const [activeCategory, setActiveCategory] = useState('Skits');
            const [message, setMessage] = useState('');
            const [showVideoModal, setShowVideoModal] = useState(false);
            const [currentVideoUrl, setCurrentVideoUrl] = useState('');

            const [showImageAdjustModal, setShowImageAdjustModal] = useState(false);
            const [imageFileToAdjust, setImageFileToAdjust] = useState(null);
            const [creatorProfile, setCreatorProfile] = useState(null);
            const [creatorCampaigns, setCreatorCampaigns] = useState([]); // State for all creator's campaigns

            const [selectedCampaignId, setSelectedCampaignId] = useState(null);
            const [selectedUserId, setSelectedUserId] = useState(null);

            // New state for admin-selected campaign details
            const [selectedAdminCampaignId, setSelectedAdminCampaignId] = useState(null);
            const [selectedAdminSubScreen, setSelectedAdminSubScreen] = useState('Overview'); // 'Overview', 'ContentManagement'


            // New state variables for custom confirmation modal
            const [showConfirmationModal, setShowConfirmationModal] = useState(false);
            const [confirmationTitle, setConfirmationTitle] = useState('');
            const [confirmationMessage, setConfirmationMessage] = useState('');
            const [onConfirmationAction, setOnConfirmationAction] = useState(null);


            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    setCurrentUser(user);
                    if (user) {
                        try {
                            const creatorDocRef = doc(db, "creators", user.uid);
                            const docSnap = await getDoc(creatorDocRef);
                            if (docSnap.exists()) {
                                const profileData = docSnap.data();
                                // Block banned users
                                if (profileData.banned) {
                                    showMessage("Your account has been banned. Please contact support.");
                                    await signOut(auth);
                                    setCurrentUser(null);
                                    setCreatorProfile(null);
                                    setActiveScreen('Home');
                                    return;
                                }
                                setCreatorProfile(profileData);
                                // Update lastLogin
                                await updateDoc(creatorDocRef, { lastLogin: new Date().toISOString() });
                            } else {
                                // New user, create profile with default role and not banned
                                await setDoc(creatorDocRef, {
                                    email: user.email,
                                    creatorName: user.email.split('@')[0] || "",
                                    bio: "",
                                    categories: [],
                                    existingWorkLink: "",
                                    profilePictureUrl: '',
                                    uploadedVideos: { youtube: null, facebook: null, tiktok: null },
                                    createdAt: new Date().toISOString(),
                                    role: 'user', // Default new users to 'user' role
                                    banned: false // Default new users to not be banned
                                });
                                const newDocSnap = await getDoc(creatorDocRef);
                                if(newDocSnap.exists()) {
                                    setCreatorProfile(newDocSnap.data());
                                }
                            }
                        } catch (error) {
                            console.error("Error fetching/creating creator profile on auth state change:", error);
                            showMessage("Error loading profile data.");
                        }
                    } else {
                        setCreatorProfile(null);
                    }
                });
                return () => unsubscribe();
            }, []);

            // New useEffect to fetch ALL of creator's campaigns for dashboard
            useEffect(() => {
                let unsubscribe = () => {};
                if (currentUser) {
                    const campaignsCollectionRef = collection(db, `artifacts/${appId}/public/data/campaigns`);
                    // Fetch all campaigns by this creator, ordered by creation date
                    const q = query(
                        campaignsCollectionRef,
                        where('creatorId', '==', currentUser.uid),
                        orderBy('createdAt', 'desc')
                    );

                    unsubscribe = onSnapshot(q, (snapshot) => {
                        const fetchedCampaigns = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setCreatorCampaigns(fetchedCampaigns);
                    }, (error) => {
                        console.error("Error fetching creator's campaigns:", error);
                        setCreatorCampaigns([]); // Clear campaigns on error
                    });
                } else {
                    setCreatorCampaigns([]); // Clear campaigns if no user
                }

                return () => unsubscribe(); // Cleanup listener
            }, [currentUser]); // Re-run when currentUser changes

            const originalCarouselImages = [
                'https://placehold.co/140x100/A0A0A0/000?text=Comedy+Night',
                'https://placehold.co/140x100/808080/FFF?text=New+Series',
                'https://placehold.co/140x100/606060/EEE?text=Exclusive',
                'https://placehold.co/140x100/404040/DDD?text=Behind+Scenes',
                'https://placehold.co/140x100/202020/CCC?text=Live+Event',
            ];
            const carouselImages = [...originalCarouselImages, ...originalCarouselImages, ...originalCarouselImages];

            const originalLiveFeedContent = [
                { id: 'lf1', title: 'New Comedy Skit: Dem Boys', creator: 'Street Jokes GY', thumbnail: 'https://placehold.co/80x60/808080/FFF?text=Skit1', url: 'https://www.youtube.com/embed/SKIT_LIVE_1?autoplay=1' },
                { id: 'lf2', title: 'Interview: Rising Star', creator: 'NVA Insights', thumbnail: 'https://placehold.co/80x60/A0A0A0/000?text=Int1', url: 'https://www.youtube.com/embed/INTERVIEW_LIVE_2?autoplay=1' },
                { id: 'lf3', title: 'Short Film Trailer: Lost Gold', creator: 'Guyana Films', thumbnail: 'https://placehold.co/80x60/606060/EEE?text=Film1', url: 'https://www.youtube.com/embed/FILM_LIVE_3?autoplay=1' },
                { id: 'lf4', title: 'Live Music Session: Reggae Vibes', creator: 'Riddim Makers', thumbnail: 'https://placehold.co/80x60/404040/DDD?text=Music1', url: 'https://www.youtube.com/embed/MUSIC_LIVE_4?autoplay=1' },
                { id: 'lf5', title: 'Behind The Scenes: Drama Shoot', creator: 'Creative Minds', thumbnail: 'https://placehold.co/80x60/202020/CCC?text=BTS1', url: 'https://www.youtube.com/embed/BTS_LIVE_5?autoplay=1' },
                { id: 'lf6', title: 'Daily Vlog: Life in Georgetown', creator: 'GT Vlogger', thumbnail: 'https://placehold.co/80x60/909090/111?text=Vlog1', url: 'https://www.youtube.com/embed/VLOG_LIVE_6?autoplay=1' },
            ];
            const liveFeedItems = [...originalLiveFeedContent, ...originalLiveFeedContent, ...originalLiveFeedContent];


            const showMessage = (msg) => {
                setMessage(msg);
                setTimeout(() => setMessage(''), 3000);
            };

            const handleVideoPress = (url) => {
                setCurrentVideoUrl(url);
                setShowVideoModal(true);
            };

            const closeVideoModal = () => {
                setShowVideoModal(false);
                setCurrentVideoUrl('');
            };

            const handleLogout = async () => {
                try {
                    await signOut(auth);
                    showMessage('Logged out successfully!');
                    setActiveScreen('Home');
                } catch (error) {
                    console.error("Error logging out:", error);
                    showMessage('Failed to log out. Please try again.');
                }
            };

                         const HomeScreen = () => {
                // --- State for fetched data ---
                const [featured, setFeatured] = useState([]);
                const [trending, setTrending] = useState([]);
                const [liveFeed, setLiveFeed] = useState([]);
                const [loading, setLoading] = useState(true);

                // New state for the endless loop
                const [displayFeatured, setDisplayFeatured] = useState([]);
                const [displayLiveFeed, setDisplayLiveFeed] = useState([]);

                // --- Refs and State for Scrolling Logic ---
                const horizontalCarouselRef = useRef(null);
                const verticalCarouselRef = useRef(null);
                const horizontalScrollIntervalRef = useRef(null);
                const verticalScrollIntervalRef = useRef(null);

                useEffect(() => {
                    const fetchContent = async () => {
                        try {
                            const contentCollectionRef = collection(db, `artifacts/${appId}/public/data/content_items`);
                            
                            // --- Query for Featured Highlights ---
                            const featuredQuery = query(contentCollectionRef, where('contentType', '==', 'Featured'), where('isActive', '==', true), orderBy('orderIndex', 'asc'));
                            const featuredSnapshot = await getDocs(featuredQuery);
                            const featuredData = featuredSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setFeatured(featuredData);
                            if (featuredData.length > 3) {
                                setDisplayFeatured([...featuredData, ...featuredData.slice(0, 3)]);
                            } else {
                                setDisplayFeatured(featuredData);
                            }

                            // --- Query for "Trending" content type specifically ---
                            const trendingQuery = query(contentCollectionRef, where('contentType', '==', 'Trending'), where('isActive', '==', true), orderBy('createdAt', 'desc'), limit(6));
                            const trendingSnapshot = await getDocs(trendingQuery);
                            setTrending(trendingSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                            
                            // --- Query for Live Feed ---
                            const liveFeedQuery = query(contentCollectionRef, where('contentType', '==', 'Live Feed'), where('isActive', '==', true), orderBy('orderIndex', 'asc'));
                            const liveFeedSnapshot = await getDocs(liveFeedQuery);
                            const liveFeedData = liveFeedSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setLiveFeed(liveFeedData);
                            if (liveFeedData.length > 2) {
                                setDisplayLiveFeed([...liveFeedData, ...liveFeedData.slice(0, 2)]);
                            } else {
                                setDisplayLiveFeed(liveFeedData);
                            }

                        } catch (error) {
                            console.error("Error fetching home screen content:", error);
                            showMessage("Failed to load content. Check connection.");
                        } finally {
                            setLoading(false);
                        }
                    };
                    fetchContent();
                }, []);

                // --- Main useEffect for Carousel Logic ---
                useEffect(() => {
                    const horizontalCarousel = horizontalCarouselRef.current;
                    const verticalCarousel = verticalCarouselRef.current;
                    let horizontalInterval;
                    let verticalInterval;

                    // --- Auto-scroll function for Horizontal Carousel ---
                    const startHorizontalScroll = () => {
                        stopHorizontalScroll();
                        if (!horizontalCarousel || featured.length <= 3) return; // Not enough items to scroll
                        
                        horizontalInterval = setInterval(() => {
                            const itemWidth = horizontalCarousel.children[0]?.clientWidth + 15 || 0;
                            // Check if we are at the end of the original list
                            if (horizontalCarousel.scrollLeft >= itemWidth * (featured.length - 1)) {
                                // Jump back to the start without animation
                                horizontalCarousel.style.scrollBehavior = 'auto';
                                horizontalCarousel.scrollLeft = 0;
                                // Restore smooth scroll after the jump
                                setTimeout(() => {
                                    horizontalCarousel.style.scrollBehavior = 'smooth';
                                    horizontalCarousel.scrollBy({ left: itemWidth, behavior: 'smooth' });
                                }, 50);
                            } else {
                                // Just scroll to the next item
                                horizontalCarousel.scrollBy({ left: itemWidth, behavior: 'smooth' });
                            }
                        }, 3000);
                    };

                    const stopHorizontalScroll = () => clearInterval(horizontalInterval);

                    // Rewritten logic for Vertical Carousel
                    const startVerticalScroll = () => {
                        stopVerticalScroll();
                        if (!verticalCarousel || liveFeed.length <= 2) return; // Not enough items to scroll

                        verticalInterval = setInterval(() => {
                            const itemHeight = verticalCarousel.children[0]?.clientHeight + 15 || 0;
                            // Check if the next scroll would go past the original items
                            if (verticalCarousel.scrollTop >= itemHeight * (liveFeed.length - 1)) {
                                // Jump to the top without animation
                                verticalCarousel.style.scrollBehavior = 'auto';
                                verticalCarousel.scrollTop = 0;
                                // Restore smooth scroll for the next movement
                                setTimeout(() => {
                                    verticalCarousel.style.scrollBehavior = 'smooth';
                                    verticalCarousel.scrollBy({ top: itemHeight, behavior: 'smooth' });
                                }, 50); // A small delay to ensure the reset is registered
                            } else {
                                // Just scroll to the next item
                                verticalCarousel.scrollBy({ top: itemHeight, behavior: 'smooth' });
                            }
                        }, 3000);
                    };

                    const stopVerticalScroll = () => clearInterval(verticalInterval);

                    // --- Initialize and add event listeners ---
                    if (!loading) {
                        startHorizontalScroll();
                        startVerticalScroll();

                        if (horizontalCarousel) {
                            horizontalCarousel.addEventListener('mouseenter', stopHorizontalScroll);
                            horizontalCarousel.addEventListener('mouseleave', startHorizontalScroll);
                        }
                        if (verticalCarousel) {
                            verticalCarousel.addEventListener('mouseenter', stopVerticalScroll);
                            verticalCarousel.addEventListener('mouseleave', startVerticalScroll);
                        }
                    }

                    // --- Cleanup Function ---
                    return () => {
                        stopHorizontalScroll();
                        stopVerticalScroll();
                        if (horizontalCarousel) {
                            horizontalCarousel.removeEventListener('mouseenter', stopHorizontalScroll);
                            horizontalCarousel.removeEventListener('mouseleave', startHorizontalScroll);
                        }
                        if (verticalCarousel) {
                            verticalCarousel.removeEventListener('mouseenter', stopVerticalScroll);
                            verticalCarousel.removeEventListener('mouseleave', startVerticalScroll);
                        }
                    };
                }, [loading, featured, liveFeed]);

                // --- START: New handler functions for manual scrolling ---
                const handleHorizontalScroll = (direction) => {
                    const carousel = horizontalCarouselRef.current;
                    if (carousel) {
                        // Calculate the width of one item including its margin
                        const itemWidth = carousel.children[0]?.clientWidth + 15;
                        const scrollAmount = direction === 'prev' ? -itemWidth : itemWidth;
                        carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
                    }
                };

                const handleVerticalScroll = (direction) => {
                    const carousel = verticalCarouselRef.current;
                    if (carousel) {
                        // Calculate the height of one item including its margin
                        const itemHeight = carousel.children[0]?.clientHeight + 15;
                        const scrollAmount = direction === 'up' ? -itemHeight : itemHeight;
                        carousel.scrollBy({ top: scrollAmount, behavior: 'smooth' });
                    }
                };
                // --- END: New handler functions for manual scrolling ---


                return (
                    <div className="screenContainer">
                        <div className="topRightButtonContainer">
                            <button className="topButton" onClick={() => setActiveScreen('Support')}>Support Us</button>
                            {currentUser ? (
                                <button className="topButton" onClick={handleLogout}>Logout</button>
                            ) : (
                                <button className="topButton" onClick={() => setActiveScreen('Login')}>Login</button>
                            )}
                        </div>

                        <p className="sectionTitle">Featured Highlights</p>
                        {/* START: Modified JSX for Featured Highlights */}
                        <div className="carousel-wrapper">
                            {displayFeatured.length > 3 && (
                                <>
                                    <button className="carousel-nav-btn prev-horizontal" onClick={() => handleHorizontalScroll('prev')}></button>
                                    <button className="carousel-nav-btn next-horizontal" onClick={() => handleHorizontalScroll('next')}></button>
                                </>
                            )}
                            <div
                                className="horizontal-carousel-container"
                                ref={horizontalCarouselRef}
                            >
                                {loading ? (
                                    [1, 2, 3, 4, 5].map(i => (
                                        <div key={i} className="horizontal-carousel-item" style={{ backgroundColor: '#2A2A2A' }}></div>
                                    ))
                                ) : (
                                    displayFeatured.map((item, index) => (
                                        <div key={`${item.id}-${index}`} className="horizontal-carousel-item" onClick={() => handleVideoPress(item.embedUrl || item.mainUrl)}>
                                            <img src={item.customThumbnailUrl} alt={item.title} className="carousel-image" />
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                        {/* END: Modified JSX for Featured Highlights */}


                        <div className="sectionHeaderWithButton">
                            <p className="sectionTitle" style={{ marginBottom: '0' }}>Trending</p>
                            {!currentUser && (
                                <div style={{display: 'flex', gap: '10px'}}>
                                    <button className="sectionHeaderButton" onClick={() => setActiveScreen('UserSignUp')}>User Sign Up</button>
                                    <button className="sectionHeaderButton" onClick={() => setActiveScreen('CreatorSignUp')}>Creator Sign Up</button>
                                </div>
                            )}
                        </div>
                        {loading ? <p>Loading trending...</p> : (
                            <div className="contentGrid">
                                {trending.map((item) => (
                                    <button key={item.id} className="contentCard" onClick={() => handleVideoPress(item.embedUrl || item.mainUrl)}>
                                        <div className="thumbnailPlaceholder" style={{backgroundImage: `url(${item.customThumbnailUrl})`, backgroundSize: 'cover', backgroundPosition: 'center'}}>
                                            <svg className="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                        </div>
                                        <p className="contentTitle">{item.title}</p>
                                    </button>
                                ))}
                            </div>
                        )}
                        <div className="sectionHeaderWithButton">
                            <p className="sectionTitle" style={{ marginBottom: '0' }}>Live Feed</p>
                            {currentUser && (
                                <div style={{display: 'flex', gap: '10px'}}>
                                    {/* --- THIS IS THE NEW BUTTON --- */}
                                    <button className="sectionHeaderButton" onClick={() => setActiveScreen('DiscoverUsers')}>Find Creators</button>
                                    
                                    <button className="sectionHeaderButton" onClick={() => setActiveScreen('Discover')}>Discover All</button>
                                </div>
                            )}
                        </div>
                        {loading ? <p>Loading live feed...</p> : (
                            /* START: Modified JSX for Live Feed */
                             <div className="carousel-wrapper">
                                {displayLiveFeed.length > 2 && (
                                    <>
                                        <button className="carousel-nav-btn prev-vertical" onClick={() => handleVerticalScroll('up')}></button>
                                        <button className="carousel-nav-btn next-vertical" onClick={() => handleVerticalScroll('down')}></button>
                                    </>
                                )}
                                <div
                                    className="vertical-carousel-container"
                                    ref={verticalCarouselRef}
                                >
                                    {displayLiveFeed.map((item, index) => (
                                        <button key={`${item.id}-${index}`} className="vertical-carousel-item" onClick={() => handleVideoPress(item.embedUrl || item.mainUrl)}>
                                            <img src={item.customThumbnailUrl} alt={item.title} className="liveFeedThumbnail" />
                                            <div className="liveFeedContent">
                                                <p className="liveFeedTitle">{item.title}</p>
                                                <p className="liveFeedCreator">by {item.creatorName}</p>
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            /* END: Modified JSX for Live Feed */
                        )}
                    </div>
                );
            };


            const PremiumScreen = () => (
                <div className="screenContainer">
                    <p className="heading">Unlock NVA Network Premium!</p>
                    <p className="subHeading">Experience Guyanese content like never before.</p>

                    <div className="premiumFeatureCard">
                        <p className="premiumFeatureTitle">1. Exclusive Content Access</p>
                        <p className="premiumFeatureDescription">
                            Get early access to new shows, premium-only series, uncensored versions,
                            and exclusive live events. Example: "Watch the full uncut version of Vibes Unfiltered before anyone else!"
                        </p>
                    </div>

                    <div className="premiumFeatureCard">
                        <p className="premiumFeatureTitle">2. Ad-Free Viewing</p>
                        <p className="premiumFeatureDescription">
                            Enjoy a seamless, uninterrupted viewing experience without in-app banner ads or pre-roll ads.
                        </p>
                    </div>

                    <div className="premiumFeatureCard">
                        <p className="premiumFeatureTitle">3. Special Perks & Giveaways</p>
                        <p className="premiumFeatureDescription">
                            Participate in monthly giveaways, exclusive merch drops, coupon codes for local businesses,
                            and priority access to virtual meet & greets.
                        </p>
                    </div>
                    <div className="premiumFeatureCard">
                        <p className="premiumFeatureTitle">5. Downloadable/Offline Viewing (Future)</p>
                        <p className="premiumFeatureDescription">
                            (Coming Soon) Download original content to watch offline, perfect for inconsistent internet.
                        </p>
                    </div>

                    <p className="sectionTitle">Pricing:</p>
                    <div className="pricingTable">
                        <div className="pricingRow">
                            <p className="pricingTier">Free</p>
                            <p className="pricingFeatures">Public videos, live shows, ads</p>
                            <p className="pricingPrice">$0</p>
                        </div>
                        <div className="pricingRow">
                            <p className="pricingTier">Premium Monthly</p>
                            <p className="pricingFeatures">All perks above</p>
                            <p className="pricingPrice">$1.99 USD / ~$400 GYD</p>
                        </div>
                        <div className="pricingRow">
                            <p className="pricingTier">Premium Yearly</p>
                            <p className="pricingFeatures">Discounted + bonus perks</p>
                            <p className="pricingPrice">$20 USD / ~$4,000 GYD</p>
                        </div>
                    </div>
                    <p className="smallText">
                        (Note: Actual payment integration would be done here using services like Stripe/PayPal.)
                    </p>
                    <button
                        className="button"
                        onClick={() => showMessage('Simulating subscription purchase. In a real app, this would initiate payment.')}
                    >
                        <span className="buttonText">Subscribe Now!</span>
                    </button>
                </div>
            );

            const AboutContactScreen = () => (
                <div className="screenContainer">
                    <p className="heading">About NVA Network</p>
                    <p className="subHeading">The Caribbeans first mobile-first entertainment network, dedicated to bringing the best of Guyanese content to a global stage.</p>

                    <p className="paragraph">
                        NVA Network is committed to empowering local creators and connecting audiences worldwide
                        with unique and vibrant stories from Guyana. Our mission is to provide a platform for Guyanese
                        comedians, filmmakers, interviewers, and live event organizers to showcase their talent,
                        reach new audiences, and build sustainable careers.
                    </p>

                    <p className="sectionTitle">Contact Us</p>
                    <p className="paragraph">
                        Have questions, feedback, or want to partner with us? Reach out!
                    </p>
                    <p className="contactInfo">Email: contact@nvanetwork.gy</p>
                    <p className="contactInfo">Phone: +592-555-NVA (Placeholder)</p>
                    <p className="contactInfo">Follow us on social media!</p>
                </div>
            );

            const CrowdfundingScreen = ({ showMessage, setActiveScreen }) => {
                const PLATFORM_FEE_PERCENTAGE = 0.07; // Define the platform fee as a constant
                return (
                    <div className="screenContainer">
                        <p className="heading">Support Guyanese Creators!</p>
                        <p className="subHeading">Help bring more authentic Guyanese content to life.</p>

                        <p className="paragraph">
                            International crowdfunding platforms often don't support direct bank accounts in Guyana,
                            making it difficult for our talented creators to receive global support.
                            At NVA Network, we're committed to finding direct ways for you to contribute!
                        </p>

                        <div className="premiumFeatureCard">
                            <p className="premiumFeatureTitle">Why Your Support Matters:</p>
                            <p className="premiumFeatureDescription">
                                Your contributions directly fund new skits, short films, interviews, and live event coverage.
                                Every dollar helps cover production costs, equipment, and fair compensation for our artists.
                            </p>
                        </div>

                        <p className="sectionTitle">How You Can Contribute Directly:</p>
                        <p className="paragraph">
                            We are setting up direct support channels that are accessible within Guyana and for our diaspora.
                            Please contact us for details on how to send your support via:
                        </p>
                        <p className="listItem"> Direct Bank Transfer (Local & International options)</p>
                        <p className="listItem"> Mobile Money Services (e.g., MMG - Mobile Money Guyana)</p>
                        <p className="listItem"> Other Local Payment Methods</p>

                        <button
                            className="button"
                            onClick={() => setActiveScreen('AllCampaigns')}
                        >
                            <span className="buttonText">Browse Creator Campaigns</span>
                        </button>
                        <p className="smallText">
                            (Discover campaigns and support your favorite creators!)
                        </p>

                        <p className="paragraph" style={{ marginTop: '20px' }}>
                            Your generosity empowers Guyanese voices and helps us build a stronger, more vibrant content ecosystem.
                            Thank you for being a part of the NVA Network family!
                        </p>

                        <p className="smallText" style={{ marginTop: '20px', color: '#888' }}>
                            A small platform fee (e.g., {(PLATFORM_FEE_PERCENTAGE * 100).toFixed(0)}%) helps NVA Network cover operational costs and continue supporting our creators.
                        </p>
                    </div>
                );
            };


            const CreatorSignUpScreen = ({ showMessage, setActiveScreen }) => {
                const [email, setEmail] = useState('');
                const [password, setPassword] = useState('');
                const [creatorName, setCreatorName] = useState('');
                const [bio, setBio] = useState('');
                const [selectedCategories, setSelectedCategories] = useState([]);
                const [existingWorkLink, setExistingWorkLink] = useState('');
                const [agreedToTerms, setAgreedToTerms] = useState(false);

                const availableCategories = ['Skits', 'Short Films', 'Interviews', 'Live Premieres', 'Music', 'Documentary', 'Other'];

                const handleCategoryChange = (e) => {
                    const { value, checked } = e.target;
                    if (checked) {
                        setSelectedCategories((prev) => [...prev, value]);
                    } else {
                        setSelectedCategories((prev) => prev.filter((cat) => cat !== value));
                    }
                };

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (!agreedToTerms) {
                        showMessage('Please agree to the Creator Terms & Conditions to sign up.');
                        return;
                    }

                    if (password.length < 8) {
                        showMessage('Password must be at least 8 characters long.');
                        return;
                    }
                    if (!/\d/.test(password)) {
                        showMessage('Password must include at least one number.');
                        return;
                    }
                    if (!/[A-Z]/.test(password)) {
                        showMessage('Password must include at least one capital letter.');
                        return;
                    }

                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;

                        const creatorRef = doc(db, "creators", user.uid);
                        await setDoc(creatorRef, {
                            email: user.email,
                            creatorName: creatorName,
                            bio: bio,
                            categories: selectedCategories,
                            existingWorkLink: existingWorkLink,
                            profilePictureUrl: '',
                            uploadedVideos: { youtube: null, facebook: null, tiktok: null },
                            createdAt: new Date().toISOString(),
                            role: 'creator', // Explicitly set role to 'creator' for this signup flow
                            banned: false // Default new users to not be banned
                        });

                        showMessage(`Creator "${creatorName}" signed up successfully! (User created in Firebase)`);
                        setActiveScreen('CreatorDashboard');
                    }
                    catch (error) {
                        console.error("Error signing up creator:", error);
                        let errorMessage = "Failed to sign up. Please try again.";
                        if (error.code === 'auth/email-already-in-use') {
                            errorMessage = "This email is already in use. Please use a different email or sign in.";
                        } else if (error.code === 'auth/invalid-email') {
                            errorMessage = "Invalid email address format.";
                        } else if (error.code === 'auth/weak-password') {
                            errorMessage = "Password is too weak. Please choose a stronger password.";
                        } else if (error.code === 'auth/network-request-failed') {
                            errorMessage = "Network error. Please check your internet connection.";
                        } else if (error.code === 'auth/operation-not-allowed') {
                            errorMessage = "Email/Password sign-in is not enabled. Please enable it in Firebase Console.";
                        } else if (error.code === 'auth/missing-or-invalid-nonce') {
                            errorMessage = "Sign-up session expired or invalid. Please refresh the page and try again.";
                        }
                        showMessage(errorMessage);
                    }
                };

                return (
                    <div className="screenContainer">
                        <p className="heading">Join NVA Network as a Creator!</p>
                        <p className="subHeading">Create your profile to share your talent and connect with your audience.</p>

                        <form onSubmit={handleSubmit}>
                            <div className="formGroup">
                                <label htmlFor="email" className="formLabel">Email:</label>
                                <input
                                    type="email"
                                    id="email"
                                    className="formInput"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                />
                            </div>

                            <div className="formGroup">
                                <label htmlFor="password" className="formLabel">Password:</label>
                                <input
                                    type="password"
                                    id="password"
                                    className="formInput"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                                <p className="smallText" style={{ textAlign: 'left', color: '#FFD700', marginTop: '5px' }}>
                                    Password must be at least 8 characters long, include at least one number and one capital letter.
                                </p>
                            </div>

                            <div className="formGroup">
                                <label htmlFor="creatorName" className="formLabel">Creator Name (Public):</label>
                                <input
                                    type="text"
                                    id="creatorName"
                                    className="formInput"
                                    value={creatorName}
                                    onChange={(e) => setCreatorName(e.target.value)}
                                    required
                                />
                            </div>

                            <div className="formGroup">
                                <label htmlFor="bio" className="formLabel">Brief Bio/Description:</label>
                                <textarea
                                    id="bio"
                                    className="formTextarea"
                                    value={bio}
                                    onChange={(e) => setBio(e.target.value)}
                                    placeholder="Tell us about yourself and your content!"
                                    required
                                ></textarea>
                            </div>

                            <div className="checkboxGroup">
                                <p className="checkboxLabel">Content Categories:</p>
                                {availableCategories.map((cat) => (
                                    <div key={cat} className="checkboxItem">
                                        <input
                                            type="checkbox"
                                            id={`cat-${cat}`}
                                            value={cat}
                                            checked={selectedCategories.includes(cat)}
                                            onChange={handleCategoryChange}
                                        />
                                        <label htmlFor={`cat-${cat}`}>{cat}</label>
                                    </div>
                                ))}
                            </div>

                            <div className="formGroup">
                                <label htmlFor="existingWork" className="formLabel">Link to Existing Work (Optional):</label>
                                <input
                                    type="url"
                                    id="existingWork"
                                    className="formInput"
                                    value={existingWorkLink}
                                    onChange={(e) => setExistingWorkLink(e.target.value)}
                                    placeholder="e.g., YouTube channel, Instagram profile"
                                />
                            </div>

                            <div className="formGroup">
                                <div className="checkboxItem">
                                    <input
                                        type="checkbox"
                                        id="agreeTerms"
                                        checked={agreedToTerms}
                                        onChange={(e) => setAgreedToTerms(e.target.checked)}
                                        required
                                    />
                                    <label htmlFor="agreeTerms">
                                        I agree to the <a href="#" className="termsLink" onClick={(e) => { e.preventDefault(); showMessage('Simulating opening Creator Terms & Conditions...'); }}>Creator Terms & Conditions</a>.
                                    </label>
                                </div>
                                <p className="termsText">
                                    NVA Network retains a **5-10% platform fee** from all crowdfunding and monetization activities
                                    to support platform operations, development, and continued promotion of Guyanese content.
                                    Detailed terms are in the full agreement.
                                </p>
                            </div>

                            <button type="submit" className="button">
                                <span className="buttonText">Sign Up as Creator</span>
                            </button>
                        </form>

                        <button
                            className="button"
                            onClick={() => setActiveScreen('Home')}
                            style={{ backgroundColor: '#3A3A3A', color: '#FFF', marginTop: '30px' }}
                        >
                            <span className="buttonText">Back to Home</span>
                        </button>
                    </div>
                );
            };

            const LoginScreen = ({ showMessage, setActiveScreen }) => {
                const [email, setEmail] = useState('');
                const [password, setPassword] = useState('');

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        showMessage(`Logged in as ${email}!`);
                        setActiveScreen('CreatorDashboard');
                    } catch (error) {
                        console.error("Error logging in:", error);
                        let errorMessage = "Login failed. Please check your credentials.";
                        if (error.code === 'auth/user-not-found') {
                            errorMessage = "No account found with that email. Please sign up or check your email.";
                        } else if (error.code === 'auth/wrong-password') {
                            errorMessage = "Incorrect password. Please try again.";
                        } else if (error.code === 'auth/invalid-email') {
                            errorMessage = "Invalid email address format.";
                        } else if (error.code === 'auth/network-request-failed') {
                            errorMessage = "Network error. Please check your internet connection.";
                        } else if (error.code === 'auth/too-many-requests') {
                            errorMessage = "Too many login attempts. Please try again later.";
                        }
                        showMessage(errorMessage);
                    }
                };

                return (
                    <div className="screenContainer">
                        <p className="heading">Creator Login</p>
                        <p className="subHeading">Access your dashboard to manage your content and campaigns.</p>

                        <form onSubmit={handleSubmit} className="loginForm">
                            <div className="formGroup">
                                <label htmlFor="loginEmail" className="formLabel">Email:</label>
                                <input
                                    type="email"
                                    id="loginEmail"
                                    className="formInput"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                />
                            </div>

                            <div className="formGroup">
                                <label htmlFor="loginPassword" className="formLabel">Password:</label>
                                <input
                                    type="password"
                                    id="loginPassword"
                                    className="formInput"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                            </div>

                            <button type="submit" className="button">
                                <span className="buttonText">Login</span>
                            </button>
                        </form>

                        <p className="smallText" style={{ marginTop: '20px' }}>
                            Don't have an account?{' '}
                            <a href="#" className="termsLink" onClick={(e) => { e.preventDefault(); setActiveScreen('CreatorSignUp'); }}>Sign Up Here</a>
                        </p>

                        <button
                            className="button"
                            onClick={() => setActiveScreen('Home')}
                            style={{ backgroundColor: '#3A3A3A', color: '#FFF', marginTop: '30px' }}
                        >
                            <span className="buttonText">Back to Home</span>
                        </button>
                    </div>
                );
            };

                    // --- REPLACEMENT COMPONENT ---
        const CreatorDashboardScreen = ({
            showMessage,
            setActiveScreen,
            currentUser,
            creatorProfile,
            setCreatorProfile,
            creatorCampaigns,
            setSelectedCampaignId,
            setShowConfirmationModal,
            setConfirmationTitle,
            setConfirmationMessage,
            setOnConfirmationAction
        }) => {
            // State for Profile Editing
            const [isEditingProfile, setIsEditingProfile] = useState(false);
            const [editCreatorName, setEditCreatorName] = useState('');
            const [editBio, setEditBio] = useState('');
            const [editCategories, setEditCategories] = useState([]);
            const [editExistingWorkLink, setEditExistingWorkLink] = useState('');
            const availableCategories = ['Skits', 'Short Films', 'Interviews', 'Live Premieres', 'Music', 'Documentary', 'Other'];

            // State for Featured Link
            const [videoLinkInput, setVideoLinkInput] = useState('');
            const [customThumbnailFile, setCustomThumbnailFile] = useState(null);
            const [customThumbnailPreview, setCustomThumbnailPreview] = useState('');
            const [autoThumbnailPreview, setAutoThumbnailPreview] = useState('');
            const [isPublishing, setIsPublishing] = useState(false);
            const thumbnailFileInputRef = useRef(null);

            // State for Profile Picture
            const profilePictureInputRef = useRef(null);
            const [showImageAdjustModal, setShowImageAdjustModal] = useState(false);
            const [imageFileToAdjust, setImageFileToAdjust] = useState(null);

            useEffect(() => {
                if (creatorProfile) {
                    setEditCreatorName(creatorProfile.creatorName || '');
                    setEditBio(creatorProfile.bio || '');
                    setEditCategories(creatorProfile.categories || []);
                    setEditExistingWorkLink(creatorProfile.existingWorkLink || '');
                    setVideoLinkInput(creatorProfile.featuredVideoLink?.url || '');
                }
            }, [creatorProfile]);

            useEffect(() => {
                setAutoThumbnailPreview('');
                if (!videoLinkInput || (creatorProfile.featuredVideoLink && videoLinkInput === creatorProfile.featuredVideoLink.url)) return;
                const handler = setTimeout(() => {
                    const { thumbnailUrl } = extractVideoInfo(videoLinkInput);
                    if (thumbnailUrl) setAutoThumbnailPreview(thumbnailUrl);
                }, 600);
                return () => clearTimeout(handler);
            }, [videoLinkInput]);

            // --- ALL PROFILE MANAGEMENT FUNCTIONS ---
            const handleSaveProfile = async () => {
                if (!editCreatorName) { showMessage("Creator name cannot be empty."); return; }
                try {
                    const creatorRef = doc(db, "creators", currentUser.uid);
                    await updateDoc(creatorRef, { creatorName: editCreatorName, bio: editBio, categories: editCategories, existingWorkLink: editExistingWorkLink, updatedAt: new Date().toISOString() });
                    setCreatorProfile(prev => ({ ...prev, creatorName: editCreatorName, bio: editBio, categories: editCategories, existingWorkLink: editExistingWorkLink }));
                    setIsEditingProfile(false);
                    showMessage('Profile updated successfully!');
                } catch (error) { showMessage(`Failed to update profile: ${error.message}`); }
            };
            const handleCancelEdit = () => {
                if (creatorProfile) {
                    setEditCreatorName(creatorProfile.creatorName || '');
                    setEditBio(creatorProfile.bio || '');
                    setEditCategories(creatorProfile.categories || []);
                    setEditExistingWorkLink(creatorProfile.existingWorkLink || '');
                }
                setIsEditingProfile(false);
            };
            const handleProfileCategoryChange = (e) => {
                const { value, checked } = e.target;
                setEditCategories(prev => checked ? [...prev, value] : prev.filter(cat => cat !== value));
            };
            const triggerProfilePictureUpload = (e) => {
                const file = e.target.files[0];
                if (file) { setImageFileToAdjust(file); setShowImageAdjustModal(true); }
            };
                const handleSaveAdjustedProfilePicture = async (adjustedBlob) => {
                if (!currentUser || !adjustedBlob) return;
                showMessage("Uploading new profile picture...");
                try {
                    const filePath = `profile_pictures/${currentUser.uid}/profile_${Date.now()}.png`;
                    const storageRefPath = ref(storage, filePath);
                    const snapshot = await uploadBytes(storageRefPath, adjustedBlob);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    const creatorRef = doc(db, "creators", currentUser.uid);
                    await updateDoc(creatorRef, { profilePictureUrl: downloadURL });
                    setCreatorProfile(prev => ({ ...prev, profilePictureUrl: downloadURL }));
                    setShowImageAdjustModal(false);
                    showMessage("Profile picture updated successfully!");
                } catch (error) {
                    console.error("Error updating profile picture:", error);
                    showMessage(`Failed to update profile picture: ${error.message}`);
                } finally {
                    // This is the new line that fixes the issue
                    if (profilePictureInputRef.current) {
                        profilePictureInputRef.current.value = null;
                    }
                }
            };
            const handleCancelAdjust = () => { setImageFileToAdjust(null); setShowImageAdjustModal(false); };

            // --- ALL CAMPAIGN MANAGEMENT FUNCTIONS ---
            const handleCancelCampaign = async (campaignId, campaignTitle) => {
                try {
                    const campaignRef = doc(db, `artifacts/${appId}/public/data/campaigns`, campaignId);
                    await updateDoc(campaignRef, { status: 'cancelled', updatedAt: new Date().toISOString() });
                    showMessage(`Campaign "${campaignTitle}" has been cancelled.`);
                } catch (error) { showMessage(`Failed to cancel campaign: ${error.message}`); }
            };
            const confirmCancelCampaign = (campaignId, campaignTitle) => {
                setConfirmationTitle("Cancel Campaign?");
                setConfirmationMessage(`Are you sure you want to cancel your campaign "${campaignTitle}"? This cannot be undone.`);
                setOnConfirmationAction(() => () => handleCancelCampaign(campaignId, campaignTitle));
                setShowConfirmationModal(true);
            };

            // --- ALL FEATURED LINK FUNCTIONS (NOW WITH FULL LOGIC) ---
            const handleAddOrUpdateVideo = async () => {
                if (!videoLinkInput) { showMessage('Please paste a URL first.'); return; }
                setIsPublishing(true);
                const { videoId, thumbnailUrl: autoThumbnailUrl, embedUrl, platform } = extractVideoInfo(videoLinkInput);
                if (!videoId) { showMessage('Invalid or unsupported URL.'); setIsPublishing(false); return; }

                let finalThumbnailUrl = autoThumbnailUrl;
                if (customThumbnailFile) {
                    showMessage('Uploading custom thumbnail...');
                    try {
                        const fileName = `thumb_${currentUser.uid}_${Date.now()}`;
                        const storageRefPath = ref(storage, `creator_uploads/${currentUser.uid}/${fileName}`);
                        await uploadBytes(storageRefPath, customThumbnailFile);
                        finalThumbnailUrl = await getDownloadURL(storageRefPath);
                        showMessage('Custom thumbnail uploaded successfully!');
                    } catch (error) { showMessage(`Thumbnail upload failed: ${error.message}`); setIsPublishing(false); return; }
                }
                
                let newContentRef;
                try {
                    const contentCollectionRef = collection(db, `artifacts/${appId}/public/data/content_items`);
                    newContentRef = await addDoc(contentCollectionRef, { title: `New from ${creatorProfile.creatorName}`, description: `Check out the latest from ${creatorProfile.creatorName}.`, mainUrl: videoLinkInput, customThumbnailUrl: finalThumbnailUrl, embedUrl, videoPlatform: platform, creatorId: currentUser.uid, creatorName: creatorProfile.creatorName, contentType: 'Live Feed', orderIndex: Date.now(), isActive: true, createdAt: new Date().toISOString(), createdBy: currentUser.uid, });
                    showMessage('Published to the Live Feed!');
                } catch (error) { showMessage(`Failed to publish to Live Feed: ${error.message}`); setIsPublishing(false); return; }

                const videoData = { url: videoLinkInput, thumbnailUrl: finalThumbnailUrl, embedUrl, platform, liveFeedContentId: newContentRef.id };
                try {
                    const creatorRef = doc(db, "creators", currentUser.uid);
                    await updateDoc(creatorRef, { featuredVideoLink: videoData, updatedAt: new Date().toISOString() });
                    setCreatorProfile(prev => ({ ...prev, featuredVideoLink: videoData }));
                    showMessage('Your featured link has been set!');
                } catch (error) { showMessage(`Failed to update your profile: ${error.message}`);
                } finally { setIsPublishing(false); }
            };

            const handleRemoveVideo = () => {
                const videoToRemove = creatorProfile.featuredVideoLink;
                if (!videoToRemove) return;
                const deletionLogic = async () => {
                    setIsPublishing(true);
                    if (videoToRemove.liveFeedContentId) {
                        try {
                            const contentDocRef = doc(db, `artifacts/${appId}/public/data/content_items`, videoToRemove.liveFeedContentId);
                            await deleteDoc(contentDocRef);
                            showMessage('Post removed from Live Feed.');
                        } catch (error) { console.error("Error deleting from live feed:", error); showMessage(`Could not remove from feed: ${error.message}`); }
                    }
                    try {
                        const creatorRef = doc(db, "creators", currentUser.uid);
                        await updateDoc(creatorRef, { featuredVideoLink: null, updatedAt: new Date().toISOString() });
                        setCreatorProfile(prev => ({ ...prev, featuredVideoLink: null }));
                        setVideoLinkInput(''); setCustomThumbnailFile(null); setCustomThumbnailPreview(''); setAutoThumbnailPreview('');
                        showMessage('Featured link removed from your profile.');
                    } catch (error) { console.error("Error removing featured video:", error); showMessage(`Failed to remove link: ${error.message}`);
                    } finally { setIsPublishing(false); }
                };
                setShowConfirmationModal(true);
                setConfirmationTitle("Remove Featured Link?");
                setConfirmationMessage("Are you sure? This will remove the link and delete the post from the public Live Feed.");
                setOnConfirmationAction(() => deletionLogic);
            };
            
            if (!creatorProfile) { return (<div className="screenContainer" style={{ textAlign: 'center', paddingTop: '50px' }}><p className="heading">Loading Your Dashboard...</p></div>); }
            
            const hasActiveCampaign = creatorCampaigns.some(c => c.status === 'active');
            const currentThumbnail = customThumbnailPreview || (creatorProfile.featuredVideoLink?.thumbnailUrl) || autoThumbnailPreview;

            return (
                <>
                    <div className="screenContainer">
                        <p className="heading">Dashboard</p>
                        <p className="subHeading">Welcome, {creatorProfile.creatorName || currentUser.email}!</p>
                        
                        {/* --- RESTORED PROFILE SECTION --- */}
                        <div className="dashboardSection">
                            <div className="flex justify-between items-center">
                                <p className="dashboardSectionTitle" style={{marginBottom: 0}}>Your Profile</p>
                                {!isEditingProfile ? (
                                    <button className="dashboardButton" onClick={() => setIsEditingProfile(true)}>Edit Profile</button>
                                ) : (
                                    <div>
                                        <button className="dashboardButton" onClick={handleSaveProfile} style={{backgroundColor: '#008000'}}>Save</button>
                                        <button className="dashboardButton" onClick={handleCancelEdit} style={{backgroundColor: '#555', color: '#FFF'}}>Cancel</button>
                                    </div>
                                )}
                            </div>
                            <div className="pt-4 border-t border-gray-200 mt-4" style={{borderColor: '#3A3A3A'}}>
                                {isEditingProfile ? (
                                    <> {/* This is the editing form */}
                                        <div className="formGroup"><label htmlFor="editCreatorName" className="formLabel">Creator Name (Public):</label><input type="text" id="editCreatorName" className="formInput" value={editCreatorName} onChange={(e) => setEditCreatorName(e.target.value)} required /></div>
                                        <div className="formGroup"><label htmlFor="editBio" className="formLabel">Bio/Description:</label><textarea id="editBio" className="formTextarea" value={editBio} onChange={(e) => setEditBio(e.target.value)} placeholder="Tell us about yourself!"></textarea></div>
                                        <div className="checkboxGroup"><p className="checkboxLabel">Content Categories:</p>{availableCategories.map((cat) => (<div key={cat} className="checkboxItem"><input type="checkbox" id={`edit-cat-${cat}`} value={cat} checked={editCategories.includes(cat)} onChange={handleProfileCategoryChange} /><label htmlFor={`edit-cat-${cat}`}>{cat}</label></div>))}</div>
                                        <div className="formGroup"><label htmlFor="editExistingWork" className="formLabel">External Link (Optional):</label><input type="url" id="editExistingWork" className="formInput" value={editExistingWorkLink} onChange={(e) => setEditExistingWorkLink(e.target.value)} placeholder="e.g., YouTube channel, Instagram" /></div>
                                    </>
                                ) : (
                                    <> {/* This is the profile display */}
                                        <div className="flex items-center mb-4"><div className="relative"><img src={creatorProfile.profilePictureUrl || 'https://placehold.co/100x100/555/FFF?text=P'} alt="Profile" style={{width: '100px', height: '100px', borderRadius: '50%', border: '2px solid #FFD700', objectFit: 'cover'}} /><input type="file" ref={profilePictureInputRef} onChange={triggerProfilePictureUpload} accept="image/*" style={{ display: 'none' }} /><button onClick={() => profilePictureInputRef.current.click()} style={{backgroundColor: '#FFD700', color: '#0A0A0A', width: '30px', height: '30px', borderRadius: '50%', border: 'none', cursor: 'pointer', position: 'absolute', bottom: 0, right: 0, display: 'flex', alignItems: 'center', justifyContent: 'center'}}></button></div><div style={{marginLeft: '1rem'}}><p className="dashboardItem" style={{fontSize: '18px', fontWeight: 'bold', color: '#FFF'}}>{creatorProfile.creatorName}</p><p className="dashboardItem" style={{fontSize: '12px', color: '#AAA'}}>Role: {creatorProfile.role}</p></div></div>
                                        <p className="dashboardItem"><strong>Bio:</strong> {creatorProfile.bio || "No bio set."}</p>
                                        <p className="dashboardItem"><strong>Categories:</strong> {creatorProfile.categories?.length > 0 ? creatorProfile.categories.join(', ') : "No categories set."}</p>
                                        <p className="dashboardItem"><strong>External Link:</strong> {creatorProfile.existingWorkLink ? <a href={creatorProfile.existingWorkLink} target="_blank" rel="noopener noreferrer" className="termsLink">{creatorProfile.existingWorkLink}</a> : "No link set."}</p>
                                    </>
                                )}
                            </div>
                        </div>

                        {/* --- NEW & IMPROVED CAMPAIGN SECTION --- */}
                        {creatorProfile.role !== 'user' && (
                            <div className="dashboardSection">
                                <div className="flex justify-between items-center">
                                    <p className="dashboardSectionTitle" style={{marginBottom: 0}}>My Crowdfunding Campaigns</p>
                                    {!hasActiveCampaign && ( <button className="dashboardButton" onClick={() => setActiveScreen('CreateCampaign')}>Create New</button> )}
                                </div>
                                <div className="pt-4 border-t border-gray-200 mt-4" style={{borderColor: '#3A3A3A'}}>
                                    {creatorCampaigns.length === 0 ? (<p className="dashboardItem">You have not created any campaigns yet.</p>) : (
                                        creatorCampaigns.map(campaign => (
                                            <div key={campaign.id} className="creator-campaign-list-item">
                                                <img src={campaign.imageUrl || 'https://placehold.co/80x50/3A3A3A/FFF?text=NVA'} alt={campaign.title} className="creator-campaign-thumbnail" onError={(e) => { e.target.src = 'https://placehold.co/80x50/3A3A3A/FFF?text=Error'; }}/>
                                                <div className="creator-campaign-info">
                                                    <p className="creator-campaign-title">{campaign.title}</p>
                                                    <p className={`creator-campaign-status status-${campaign.status}`}>Status: {campaign.status.charAt(0).toUpperCase() + campaign.status.slice(1)}</p>
                                                </div>
                                                {campaign.status !== 'cancelled' && campaign.status !== 'ended' && (<button className="actionButton" style={{backgroundColor: '#DC3545'}} onClick={() => confirmCancelCampaign(campaign.id, campaign.title)}>Cancel</button>)}
                                            </div>
                                        ))
                                    )}
                                    {hasActiveCampaign && (<p className="smallText" style={{textAlign: 'center', color: '#FFD700', marginTop: '15px'}}>You must cancel or wait for your active campaign to end before creating a new one.</p>)}
                                </div>
                            </div>
                        )}

                        {/* --- RESTORED FEATURED LINK SECTION --- */}
                        {creatorProfile.role !== 'user' && (
                            <div className="dashboardSection">
                                <p className="dashboardSectionTitle">My Featured Link</p>
                                <p className="dashboardItem" style={{color: '#AAA', lineHeight: 1.4, marginBottom: '15px'}}>Post a link to your latest video. This will be featured on your profile and posted to the Live Feed.</p>
                                <div className="videoLinkSection">
                                    <label htmlFor="featuredVideoLink" className="formLabel">URL:</label>
                                    <div className="videoInputContainer"><input type="url" id="featuredVideoLink" className="formInput" value={videoLinkInput} onChange={(e) => setVideoLinkInput(e.target.value)} placeholder="Paste your link here" /></div>
                                    {!creatorProfile.featuredVideoLink && (<div className="formGroup" style={{marginTop: '15px'}}><label htmlFor="customThumbnailFile" className="formLabel">Custom Thumbnail (Optional):</label><input type="file" id="customThumbnailFile" ref={thumbnailFileInputRef} className="formInput" onChange={(e) => { const file = e.target.files[0]; setCustomThumbnailFile(file); if (file) { setCustomThumbnailPreview(URL.createObjectURL(file)); } else { setCustomThumbnailPreview(''); }}} accept="image/*" style={{padding: '10px 0', border: 'none', backgroundColor: 'transparent'}} /></div>)}
                                    {currentThumbnail && ( <div style={{marginTop: '10px'}}><p className="formLabel" style={{marginBottom: '5px'}}>Thumbnail Preview:</p><img src={currentThumbnail} alt="Thumbnail Preview" style={{ maxWidth: '200px', borderRadius: '8px', border: '2px solid #FFD700' }} onError={(e) => { e.target.style.display = 'none'; }} /></div> )}
                                    <div className="videoActions" style={{marginTop: '20px', justifyContent: 'flex-start'}}>
                                        {!creatorProfile.featuredVideoLink ? ( <button className="adminActionButton approve" onClick={handleAddOrUpdateVideo} disabled={isPublishing} style={{padding: '10px 20px', fontSize: '14px', cursor: isPublishing ? 'not-allowed' : 'pointer', opacity: isPublishing ? 0.6 : 1}}>{isPublishing ? 'Publishing...' : 'Publish URL'}</button> ) : ( <button className="adminActionButton reject" onClick={handleRemoveVideo} disabled={isPublishing} style={{padding: '10px 20px', fontSize: '14px', cursor: isPublishing ? 'not-allowed' : 'pointer', opacity: isPublishing ? 0.6 : 1}}>{isPublishing ? 'Removing...' : 'Remove Link'}</button> )}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        <button className="button" onClick={() => setActiveScreen('Home')} style={{ backgroundColor: '#3A3A3A', color: '#FFF', marginTop: '30px' }}><span className="buttonText">Back to Home</span></button>
                    </div>
                     {showImageAdjustModal && imageFileToAdjust && (<ProfilePictureAdjustModal imageUrl={URL.createObjectURL(imageFileToAdjust)} onSave={handleSaveAdjustedProfilePicture} onCancel={handleCancelAdjust} showMessage={showMessage} />)}
                </>
            );
        };
        // --- END OF REPLACEMENT COMPONENT ---

const renderScreen = () => {
                switch (activeScreen) {
                    case 'Home':
                        return <HomeScreen />;
                    case 'Discover':
                        if (!currentUser) {
                            showMessage("Please log in to discover all content.");
                            return <LoginScreen showMessage={showMessage} setActiveScreen={setActiveScreen} />;
                        }
                        return <CategoriesScreen showMessage={showMessage} />;
                    
                    case 'DiscoverUsers':
                        return <DiscoverUsersScreen
                            showMessage={showMessage}
                            setActiveScreen={setActiveScreen}
                            setSelectedCampaignId={setSelectedCampaignId}
                            creatorProfile={creatorProfile}
                            setSelectedUserId={setSelectedUserId} 
                        />;

                    case 'UserProfile':
                        return <UserProfileScreen
                            selectedUserId={selectedUserId}
                            setActiveScreen={setActiveScreen}
                            setSelectedCampaignId={setSelectedCampaignId}
                            showMessage={showMessage}
                        />;

                    case 'Login':
                        return <LoginScreen showMessage={showMessage} setActiveScreen={setActiveScreen} />;
                    case 'UserSignUp':
                        return <UserSignUpScreen showMessage={showMessage} setActiveScreen={setActiveScreen} />;
                    case 'CreatorSignUp':
                        return <CreatorSignUpScreen showMessage={showMessage} setActiveScreen={setActiveScreen} />;
                    case 'Premium':
                        if (!currentUser) {
                            showMessage("Please log in to access Premium features.");
                            return <LoginScreen showMessage={showMessage} setActiveScreen={setActiveScreen} />;
                        }
                        return <PremiumScreen />;
                    case 'Support':
                        return <CrowdfundingScreen showMessage={showMessage} setActiveScreen={setActiveScreen} />;
                    case 'AllCampaigns': 
                        return <AllCampaignsScreen showMessage={showMessage} setActiveScreen={setActiveScreen} setSelectedCampaignId={setSelectedCampaignId} />;
                    case 'CampaignDetails':
                        return <CampaignDetailsScreen showMessage={showMessage} setActiveScreen={setActiveScreen} selectedCampaignId={selectedCampaignId} currentUser={currentUser} />;
                    case 'CreatorDashboard':
                        return <CreatorDashboardScreen showMessage={showMessage} setActiveScreen={setActiveScreen} currentUser={currentUser} creatorProfile={creatorProfile} setCreatorProfile={setCreatorProfile} creatorCampaigns={creatorCampaigns} setSelectedCampaignId={setSelectedCampaignId} setShowConfirmationModal={setShowConfirmationModal} setConfirmationTitle={setConfirmationTitle} setConfirmationMessage={setConfirmationMessage} setOnConfirmationAction={setOnConfirmationAction} />;
                    
                    case 'CreateCampaign':
                        return <CreateCampaignScreen
                            showMessage={showMessage}
                            setActiveScreen={setActiveScreen}
                            currentUser={currentUser}
                            creatorProfile={creatorProfile}
                        />;
                    
                    case 'AdminDashboard':
                        return <AdminDashboardScreen showMessage={showMessage} setActiveScreen={setActiveScreen} currentUser={currentUser} setSelectedAdminCampaignId={setSelectedAdminCampaignId} creatorProfile={creatorProfile} selectedAdminSubScreen={selectedAdminSubScreen} setSelectedAdminSubScreen={setSelectedAdminSubScreen} setShowConfirmationModal={setShowConfirmationModal} setConfirmationTitle={setConfirmationTitle} setConfirmationMessage={setConfirmationMessage} setOnConfirmationAction={setOnConfirmationAction} />;
                    
                    case 'AdminCampaignDetails': 
                        return <AdminCampaignDetailsScreen showMessage={showMessage} setActiveScreen={setActiveScreen} currentUser={currentUser} selectedAdminCampaignId={selectedAdminCampaignId} setShowConfirmationModal={setShowConfirmationModal} setConfirmationTitle={setConfirmationTitle} setConfirmationMessage={setConfirmationMessage} setOnConfirmationAction={setOnConfirmationAction} creatorProfile={creatorProfile} />;

                    default:
                        return <HomeScreen />;
                }
            };

            return (
                <div className="container">
                    <div className="header">
                        <img
                            src="https://nva-network-app.netlify.app/NVA%20Network%20LOGO%20FX.png"
                            alt="NVA Network Logo"
                            className="headerLogo"
                            onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/450x150/1A1A1A/FFD700?text=Logo+Error'; }}
                        />
                        <p className="headerTitle">NVA Network</p>
                        <p className="tagline">Guyanese Content to a Global Stage.</p>
                    </div>

                    {renderScreen()}

                    <div className="navigationBar">
                        <button className="navButton" onClick={() => setActiveScreen('Home')}>
                            <span className={`navButtonText ${activeScreen === 'Home' ? 'activeNavButtonText' : ''}`}>Home</span>
                        </button>
                        {currentUser && (
                            <button className="navButton" onClick={() => setActiveScreen('Premium')}>
                                <span className={`navButtonText ${activeScreen === 'Premium' ? 'activeNavButtonText' : ''}`}>Premium</span>
                            </button>
                        )}
                        {currentUser && (
                            <button className="navButton" onClick={() => setActiveScreen('CreatorDashboard')}>
                                <span className={`navButtonText ${activeScreen === 'CreatorDashboard' ? 'activeNavButtonText' : ''}`}>Dashboard</span>
                            </button>
                        )}
                        {currentUser && creatorProfile && (creatorProfile.role === 'admin' || creatorProfile.role === 'authority') && (
                            <button className="navButton" onClick={() => setActiveScreen('AdminDashboard')}>
                                <span className={`navButtonText ${activeScreen === 'AdminDashboard' ? 'activeNavButtonText' : ''}`}>Admin</span>
                            </button>
                        )}
                        <button className="navButton" onClick={() => setActiveScreen('About')}>
                            <span className={`navButtonText ${activeScreen === 'About' ? 'activeNavButtonText' : ''}`}>About</span>
                        </button>
                    </div>

                    {message && (
                        <div className="messageBox">
                            <p className="messageText">{message}</p>
                        </div>
                    )}

                    {showVideoModal && (
                        <VideoPlayerModal videoUrl={currentVideoUrl} onClose={closeVideoModal} />
                    )}

                    {showConfirmationModal && (
                        <ConfirmationModal
                            title={confirmationTitle}
                            message={confirmationMessage}
                            onConfirm={onConfirmationAction}
                            onCancel={() => setShowConfirmationModal(false)}
                        />
                    )}
                </div>
            );
        }

        window.onload = function() {
            if (
                typeof window.firebaseAuth === 'undefined' ||
                typeof window.onAuthStateChanged === 'undefined' ||
                typeof window.firebaseDb === 'undefined' ||
                typeof window.firebaseStorage === 'undefined' ||
                typeof ReactDOM === 'undefined'
            ) {
                console.error("Firebase or ReactDOM not fully initialized. Retrying render...");
                setTimeout(window.onload, 100);
                return;
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        };
    </script>
</body>
</html>
