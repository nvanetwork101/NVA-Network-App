rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isAuthenticated() { return request.auth != null; }
    function getMyData() { return get(/databases/$(database)/documents/creators/$(request.auth.uid)).data; }
    function getUserData(userId) { return get(/databases/$(database)/documents/creators/$(userId)).data; }
    function isAdmin() { return isAuthenticated() && getMyData().role == 'admin'; }
    function isAuthority() { return isAuthenticated() && getMyData().role == 'authority'; }
    function isModerator() { return isAuthenticated() && (getMyData().role == 'admin' || getMyData().role == 'authority'); }

    // --- COLLECTION RULES ---

    match /creators/{userId} {
      // FIX: Allow any authenticated user to read a profile. This resolves the login error.
      allow read: if request.auth.uid != null;
      
      // Allow a user to create their own document.
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Allow a user to update their own document, but not change their role/ban status.
      // Also allows admins/authorities to make changes.
      allow update: if
        (isAuthenticated() && request.auth.uid == userId &&
          (!('role' in request.resource.data) || request.resource.data.role == resource.data.role) &&
          (!('banned' in request.resource.data) || request.resource.data.banned == resource.data.banned)
        ) ||
        (isAdmin()) ||
        (isAuthority() && getUserData(userId).role != 'admin');
        
      // Do not allow users to be deleted from the client.
      allow delete: if false;

      // --- NEW: Scalable Follow System Rules ---
      
      // Rule for the "followers" subcollection of a user.
      match /followers/{followerId} {
        // Anyone can see who follows a user.
        allow read: if true;
        // You can only add or remove YOURSELF from someone's followers list.
        allow write: if isAuthenticated() && request.auth.uid == followerId;
      }

      // Rule for the "following" subcollection of a user.
      match /following/{followedUserId} {
        // FIX: Allow anyone to see who a user is following. This resolves the second error.
        allow read: if true;
        // You can only modify your OWN "following" list.
        allow write: if isAuthenticated() && request.auth.uid == userId;
      }
    }

    // NOTE: The old top-level "/follows" collection is no longer needed with this new model.
    // It has been removed.

    match /leaderboard/{docId} {
        allow read: if true;
        allow write: if false;
    }

    match /content_categories/{categoryId} {
      allow read: if true; 
      allow create, update, delete: if isModerator();
    }
    
    match /banRequests/{requestId} {
      allow create: if getMyData().role == 'authority' && request.resource.data.requesterId == request.auth.uid;
      allow read: if isAdmin();
      allow delete: if isAdmin();
      allow update: if false;
    }

    match /artifacts/{appId}/public/data/content_items/{contentId} {
      allow read: if resource.data.isActive == true || isModerator() || request.auth.uid == resource.data.createdBy;
      allow create: if isModerator() || (isAuthenticated() && request.auth.uid == request.resource.data.createdBy);
      allow update: if isModerator() || (isAuthenticated() && request.resource.data.keys().hasOnly(['viewCount', 'likeCount']));
      allow delete: if isAuthenticated() && (request.auth.uid == resource.data.createdBy || isAdmin() || (isAuthority() && getUserData(resource.data.createdBy).role != 'admin'));
      
      match /likes/{userId} {
        allow read: if isAuthenticated();
        allow create, delete: if isAuthenticated() && request.auth.uid == userId;
        allow update: if false;
      }
      
      match /daily_clicks/{date} {
        allow write: if isAuthenticated() &&
                      request.auth.uid != get(/databases/$(database)/documents/artifacts/$(appId)/public/data/content_items/$(contentId)).data.createdBy;
      }
    }

    match /artifacts/{appId}/public/data/campaigns/{campaignId} {
      allow read: if (resource.data.status == 'active') || (isAuthenticated() && resource.data.creatorId == request.auth.uid) || (isModerator());
      allow create: if (isAuthenticated() && request.resource.data.creatorId == request.auth.uid && request.resource.data.status == 'pending' && request.resource.data.raised == 0);
      allow update: if isAuthenticated() && ( (request.resource.data.raised > resource.data.raised && request.resource.data.keys().hasOnly(['raised', 'updatedAt'])) || (resource.data.creatorId == request.auth.uid && request.resource.data.status == 'cancelled' && request.resource.data.keys().hasAll(['status', 'updatedAt', 'statusChangedAt'])) || (isAdmin()) || (isAuthority() && getUserData(resource.data.creatorId).role != 'admin') );
      allow delete: if false;

      match /donations/{donationId} {
        allow read: if isModerator() || (isAuthenticated() && get(/databases/$(database)/documents/artifacts/$(appId)/public/data/campaigns/$(campaignId)).data.creatorId == request.auth.uid);
        allow create: if isAuthenticated();
      }
    }
  }
}
